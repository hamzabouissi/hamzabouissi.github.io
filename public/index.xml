<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>chown u&#43;r mind</title>
    <link>//localhost:1313/</link>
    <description>Recent content on chown u&#43;r mind</description>
    <image>
      <title>chown u&#43;r mind</title>
      <url>//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</url>
      <link>//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E</link>
    </image>
    <generator>Hugo -- 0.133.0</generator>
    <language>en-us</language>
    <lastBuildDate>Mon, 12 Aug 2024 14:42:01 +0100</lastBuildDate>
    <atom:link href="//localhost:1313/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Transform AWS Exam Generator Architecture to Open Source Part #5: Authentication and Emailing</title>
      <link>//localhost:1313/posts/transform-aws-5/</link>
      <pubDate>Mon, 12 Aug 2024 14:42:01 +0100</pubDate>
      <guid>//localhost:1313/posts/transform-aws-5/</guid>
      <description>Introduction In this article, we’re going to replace the Cognito Service, I choose the Kratos and Oathkeeper from Ory as alternative.
The main functionalities of Congito here, is offering a way to sign in, sign up with or without SSO, email verification and use Sesssion Web Token for Frontend authorization.
Here is the full architecture of authentication and authorization
Don&amp;rsquo;t worry if didnt understand the architecture, we will dig deeper in the next headlines</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>In this article, we’re going to replace the Cognito Service, I choose the Kratos and Oathkeeper from Ory as alternative.</p>
<p>The main functionalities of Congito here, is offering a way to sign in, sign up with or without SSO, email verification and use Sesssion Web Token for Frontend authorization.</p>
<p>Here is the full architecture of authentication and authorization</p>
<p><img loading="lazy" src="/img/kratos-oathkeeper-arch.png" alt="ory_arch"  />
</p>
<p>Don&rsquo;t worry if didnt understand the architecture, we will dig deeper in the next headlines</p>
<h2 id="kratos">Kratos</h2>
<p>Kratos is an identity and user management service, we will use it to authenticate user in, verify the email and generate Session Web token to pass it to authorization service later.</p>
<p>One feature that others will consider it a downside is <strong>Kratos</strong> doesn’t come with an UI, but Ory have created a separate <a href="https://github.com/ory/kratos-selfservice-ui-node">repo</a>. The repo has a dockerfile to build the image, it stay to us to create a helm chart.</p>
<p>The installation of kratos is handled by a helm chart, but we need to change few values first:</p>
<p>Kratos needs a database to store its state, so we supply a connection string of our private database, I created the user kratos earlier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dsn</span><span class="p">:</span><span class="w"> </span><span class="l">postgresql://kratos:kratos@cluster-pg-rw.cnpg-system.svc.cluster.local:5432/kratos</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>For sending emails, a separate service is created alongside the kratos api, to get it working we add the <strong>SMTP</strong> credentials we have, I use mailgun as it provides an easy interface and integration mechanism with python, the <strong>from_address</strong> property here is the address that’s will appear in your inbox when you receive an email.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">courier</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">smtp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">connection_uri</span><span class="p">:</span><span class="w"> </span><span class="l">xxxxxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">from_address</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span>-<span class="l">reply@enkinineveh.space</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Flows property defines each stage like <code>login</code>, <code>registration</code>, <code>verification</code> and <code>errors</code>, because we’re using kratos UI all those pages will be under the root url like registration will be under: /registration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">flows</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">error</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/error</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">login</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/login</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verification</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/verification</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">registration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/registration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">settings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/settings</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We said before we need to send a verification email, and prevent unverified users from login by using this hook, so we modify the login to adjust the use case</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">flows</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">login</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/login</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">after</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hooks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">hook</span><span class="p">:</span><span class="w"> </span><span class="l">require_verified_address</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We will not enable ingress, because kratos-ui requires both services to be deployed under the same host, but unfortunately kratos-api helm chart doesn’t enable this, that’s why we will offload this to kratos-ui chart.</p>
<p>The domain we’re going to host the kratos-ui in is <strong>kratos.enkinineveh.space</strong> and the kratos api under <strong>/app</strong> path, then we pass environment variable to specify <strong>kratos-app</strong> url, <strong>CSRF_COOKIE_NAME</strong> and two random secret values</p>
<p>kratos-ui values.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/rewrites</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;serviceName=kratos-public rewrite=/&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">kratos.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos-ui-charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos-public</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">enkinineveh.space-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">kratos.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-env-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">CSRF_COOKIE_NAME</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;__HOST-kratos.enkinineveh.space&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">COOKIE_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;e482c93bc1e9eab3cd65105128b0615accecceeff100c541b06b1698bca6a497&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">CSRF_COOKIE_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;a22736d7cefe107b2bf0a156984d9af35e32ff642290c23e5c054ca10ccde879&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">DANGEROUSLY_DISABLE_SECURE_CSRF_COOKIES</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">KRATOS_PUBLIC_URL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://kratos.enkinineveh.space/app&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">KRATOS_ADMIN_URL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://kratos-admin.auth&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>To keep clean seperation, I created a seperate <code>auth</code> folder, Now let&rsquo;s deploy both services and test it out:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">releases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">ory/kratos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">exam</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">kratos/kratos-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./kratos-ui-node/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">exam</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helmfile apply
</span></span></code></pre></td></tr></table>
</div>
</div><p>and here it goes, let’s head into registration to create a user, then if we try to login, it&rsquo;ll prevent us, so we must verify the user first using the verification form.</p>
<video width="640" height="360" controls>
  <source src="/videos/kratos-account-verify.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<p>Next thing is deploying oathkeeper and sharing this session to authenticate the user.</p>
<h2 id="oathkeeper">Oathkeeper</h2>
<p>Oathkeeper has two components API and Proxy, we will pick the proxy service to live in front of the exam-gen and exam-taking UI.</p>
<p><img loading="lazy" src="https://gruchalski.com/assets/posts/2021-05-20/oathkeeper-proxy-mode.png" alt="oathkeeper-arch"  />
</p>
<p>The Oathkeeper Proxy service has an access list to decide which request should be allowed or deny it. For example we can enable a <strong>cookie_session</strong> on url <strong>exam-generate-frontend</strong> that reference exam-generate internal upstream service</p>
<p>oathkeeper values.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">oathkeeper</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- The ORY Oathkeeper configuration. For a full list of available settings, check:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   https://github.com/ory/oathkeeper/blob/master/docs/config.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessRules</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;id&#34;: </span><span class="s2">&#34;exam-generation-rule&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;upstream&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;url&#34;: </span><span class="s2">&#34;http://exam-generation-frontend-charts:8501&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;match&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;url&#34;: </span><span class="s2">&#34;https://exam-generate-frontend.enkinineveh.space/&lt;.*&gt;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;methods&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;GET&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;POST&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;OPTIONS&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;PUT&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;PATCH&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;authenticators&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;cookie_session&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;authorizer&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;mutators&#34;: </span><span class="p">[</span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;header&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;config&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">&#34;headers&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">&#34;X-USER-EMAIL&#34;: </span><span class="s2">&#34;{{ print .Extra.identity }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;errors&#34;</span><span class="p">:[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;handler&#34;</span><span class="p">:</span><span class="s2">&#34;redirect&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="p">,</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>also we saw in previous article that the front-take exam needs the authenticated user’s email.</p>
<p>From the oathkeeper documentation we can leverage that with the “header” mutator, but I tried it many times and couldn&rsquo;t get it to work.
If you have any idea how to make it work, I will be pleased to talk.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;id&#34;: </span><span class="s2">&#34;exam-taking-rule&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;upstream&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;url&#34;: </span><span class="s2">&#34;http://exam-taking-frontend-charts:8501&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;match&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;url&#34;: </span><span class="s2">&#34;https://exam-taking-frontend.enkinineveh.space/&lt;.*&gt;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;methods&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;GET&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;POST&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;OPTIONS&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;PUT&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;PATCH&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;HEAD&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;authenticators&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;cookie_session&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;authorizer&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;mutators&#34;: </span><span class="p">[</span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;header&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;config&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;headers&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">&#34;X-USER-EMAIL&#34;: </span><span class="s2">&#34;{{ print .Extra.identity }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;errors&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;handler&#34;</span><span class="p">:</span><span class="s2">&#34;redirect&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>But you may ask yourself if oathkeeper and kratos are two separate services , how can oathkeeper verify the kratos cookie_session ?</p>
<p>Well kratos API provides the URL: <code>/sessions/whoami</code> to verify cookies, so when adding the cookie_session authenticator, we pass that url with few extra parameters</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">authenticators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cookie_session</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">check_session_url</span><span class="p">:</span><span class="w"> </span><span class="l">http://kratos-public.exam/sessions/whoami</span><span class="w"> </span><span class="c"># this reference kratos internal url</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">forward_http_headers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">Cookie</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">X-USER-EMAIL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">preserve_path</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">extra_from</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;@this&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># kratos will be configured to put the subject from the IdP here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">subject_from</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;identity.traits.email&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">only</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">ory_kratos_session</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and one last thing in the configuration side is telling oathkeeper to redirect unauthorised requests to kratos login page and the <code>return_to_query_param</code> property is for redirecting user back to UI after successfully login</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">errors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">redirect</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/login</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">return_to_query_param</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;return_to&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">when</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="nt">error</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span>- <span class="l">unauthorized</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and we dont&rsquo;t forget to add the frontend domain into kratos <code>allowed_return_urls</code>, so requests cannot get blocked</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">selfservice</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">allowed_return_urls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">https://kratos.enkinineveh.space/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">https://exam-taking-frontend.enkinineveh.space/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">https://exam-generate-frontend.enkinineveh.space/</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Proxy service will be deployed in front of the UI apps, so we update the ingress of the both frontend apps to redirect traffic to oathkeeper-proxy dns and othkeeper proxy will decide based on the access rules if the request should be allowed or not.</p>
<p><code>exam-taking-app values.yaml</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">ImplementationSpecific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">oathkeeper-proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">4455</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/_stcore/stream</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">ImplementationSpecific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend-charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">8501</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>exam-generate-app values.yaml</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">exam-generate-frontend.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">ImplementationSpecific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">oathkeeper-proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">4455</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/_stcore/stream</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">ImplementationSpecific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-generation-frontend-charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">8501</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>here is a demo for authorization</p>
<video width="640" height="360" controls>
  <source src="/videos/oathkeeper-login.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<h2 id="after-registration--emailing">After registration &amp; Emailing</h2>
<h3 id="postsignup-function">PostSignUp Function</h3>
<p>We nearly implement all the functionalities Cognito provides in this architecture but there is one missing feature, which is calling a <code>PostSignUp</code> function after registration to subscribe the educator to an Amazon Simple Notification Service , but in our case, we call <code>PostSignUp</code> to add a educator email in <code>subscribers</code> table so then the <code>email-fn</code> retrieve the email to send notifications to.</p>
<p>We start by creating the function, it should serve two main roles: intercepting the event and persisting the email inside a dynamodb table.
The handler function will get the email from <code>event['traits']['email']</code> as this the format kratos webhook use, then we created a mongo client and inserted the email into <code>MONGO_TABLE_NAME</code> .</p>
<p>So here the code of  <code>main.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_subscriber</span><span class="p">(</span><span class="n">email</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize DynamoDB table</span>
</span></span><span class="line"><span class="cl">    <span class="n">table_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGO_TABLE_NAME&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGO_URI&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s2">&#34;exams&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">subscribers</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s2">&#34;email&#34;</span><span class="p">:</span><span class="n">email</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">subscribers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">email</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;traits&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">create_subscriber</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Wrap it inside FastAPI, build the image and push it into the registry.
Then we reference the image and add the environment variables to <code>values.yaml</code> as always:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">gitea.enkinineveh.space/gitea_admin/post-signup-fn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Overrides the image tag whose default is the chart appVersion.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;v1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">normal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_URI</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;mongodb://databaseAdmin:sHWKYbXRalmNExTMiYr@my-cluster-name-rs0.mongo.svc.cluster.local/admin?replicaSet=rs0&amp;ssl=false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_TABLE_NAME</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;subscribers&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After deploying the chart, we retrive the service URL:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get kservice -n exam post-signup-fn-charts
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                    URL                                                   LATESTCREATED                 LATESTREADY                   READY   REASON
</span></span><span class="line"><span class="cl">post-signup-fn-charts   http://post-signup-fn-charts.exam.svc.cluster.local   post-signup-fn-charts-00001   post-signup-fn-charts-00001   True
</span></span></code></pre></td></tr></table>
</div>
</div><p>The other part of the puzzle is configuring kratos webhook to send <strong>educator only</strong> email to this functions, but how shall we identity educator emails from the student ones ?.</p>
<p>The answer to this question is adding another choice field contains user types, either: <strong>educator</strong> or <strong>student</strong>.
To achieve this, we will leverage the &ldquo;custom identity schema&rdquo; kratos provides, we already implemented the concept in previous step but we didn&rsquo;t talk about it.</p>
<p>Identity schema is the form you&rsquo;re seeing when you access the registration page, by default it comes with just email, password, fullanme , but we can customize it, to do that we change <code>identity.schemas</code> property. one side note is the identity schema use <a href="https://json-schema.org">json-schema</a> to create and validate forms</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;$id&#34;</span><span class="p">:</span> <span class="s2">&#34;https://schemas.ory.sh/presets/kratos/identity.email.schema.json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;$schema&#34;</span><span class="p">:</span> <span class="s2">&#34;http://json-schema.org/draft-07/schema#&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;Person&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;traits&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;E-Mail&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ory.sh/kratos&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;credentials&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;recovery&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;verification&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;fullname&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;Full Name&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;phone_number&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;number&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;title&#34;</span><span class="p">:</span><span class="s2">&#34;Phone Number&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user_type&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="err">#</span> <span class="err">we</span> <span class="err">add</span> <span class="err">this</span> <span class="err">field</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;title&#34;</span><span class="p">:</span><span class="s2">&#34;User Type&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;enum&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;student&#34;</span><span class="p">,</span> <span class="s2">&#34;educator&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;default&#34;</span><span class="p">:</span> <span class="s2">&#34;student&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;email&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;fullname&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;phone_number&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;user_type&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;additionalProperties&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we encode(base64) the following schema and pass it to <code>identity.schemas</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">identity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default_schema_id</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">schemas</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">base64://ew0KICAiJGlkIjogImh0dHBzOi8vc2NoZW1hcy5vcnkuc2gvcHJlc2V0cy9rcmF0b3MvaWRlbnRpdHkuZW1haWwuc2NoZW1hLmpzb24iLA0KICAiJHNjaGVtYSI6ICJodHRwOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LTA3L3NjaGVtYSMiLA0KICAidGl0bGUiOiAiUGVyc29uIiwNCiAgInR5cGUiOiAib2JqZWN0IiwNCiAgInByb3BlcnRpZXMiOiB7DQogICAgInRyYWl0cyI6IHsNCiAgICAgICJ0eXBlIjogIm9iamVjdCIsDQogICAgICAicHJvcGVydGllcyI6IHsNCiAgICAgICAgImVtYWlsIjogew0KICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsDQogICAgICAgICAgImZvcm1hdCI6ICJlbWFpbCIsDQogICAgICAgICAgInRpdGxlIjogIkUtTWFpbCIsDQogICAgICAgICAgIm9yeS5zaC9rcmF0b3MiOiB7DQogICAgICAgICAgICAiY3JlZGVudGlhbHMiOiB7DQogICAgICAgICAgICAgICJwYXNzd29yZCI6IHsNCiAgICAgICAgICAgICAgICAiaWRlbnRpZmllciI6IHRydWUNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICJyZWNvdmVyeSI6IHsNCiAgICAgICAgICAgICAgInZpYSI6ICJlbWFpbCINCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICAidmVyaWZpY2F0aW9uIjogew0KICAgICAgICAgICAgICAidmlhIjogImVtYWlsIg0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfSwNCiAgICAgICAgImZ1bGxuYW1lIjp7DQogICAgICAgICAgInR5cGUiOiJzdHJpbmciLA0KICAgICAgICAgICJ0aXRsZSI6ICJGdWxsIE5hbWUiDQogICAgICAgIH0sDQogICAgICAgICJwaG9uZV9udW1iZXIiOnsNCiAgICAgICAgICAidHlwZSI6Im51bWJlciIsDQogICAgICAgICAgInRpdGxlIjoiUGhvbmUgTnVtYmVyIg0KICAgICAgICB9LA0KICAgICAgICAidXNlcl90eXBlIjogew0KICAgICAgICAgICJ0aXRsZSI6IlVzZXIgVHlwZSIsDQogICAgICAgICAgInR5cGUiOiAic3RyaW5nIiwNCiAgICAgICAgICAiZW51bSI6IFsic3R1ZGVudCIsICJlZHVjYXRvciJdLCANCiAgICAgICAgICAiZGVmYXVsdCI6ICJzdHVkZW50Ig0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgInJlcXVpcmVkIjogWw0KICAgICAgICAiZW1haWwiLA0KICAgICAgICAiZnVsbG5hbWUiLA0KICAgICAgICAicGhvbmVfbnVtYmVyIiwidXNlcl90eXBlIg0KICAgICAgXSwNCiAgICAgICJhZGRpdGlvbmFsUHJvcGVydGllcyI6IGZhbHNlDQogICAgfQ0KICB9DQp9</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>here is the new form:</p>
<p><img loading="lazy" src="/img/kratos-registration-form.png" alt="kratos-new-registration-form"  />
</p>
<p>Getting back to the webhook configuration, we will set an after registration webhook</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">registration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/registration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">after</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hooks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">hook</span><span class="p">:</span><span class="w"> </span><span class="l">web_hook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://post-signup-fn-charts.exam.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">body</span><span class="p">:</span><span class="w"> </span><span class="l">base64://empty_for_now</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;POST&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">can_interrupt</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">emit_analytics_event</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>you may notice we didn&rsquo;t supply the body, based on the documentation, kratos use jsonnet to define the logic.</p>
<p>The code will intercept the event and pass only educator emails</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function(ctx)
</span></span><span class="line"><span class="cl">if ctx.identity.traits.user_type == &#34;student&#34; then
</span></span><span class="line"><span class="cl">  error &#34;cancel&#34;
</span></span><span class="line"><span class="cl">else
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">    &#34;traits&#34;: {
</span></span><span class="line"><span class="cl">      &#34;email&#34;: ctx.identity.traits.email
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we encode it as base64 and pass it to the body param</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://post-signup-fn-charts.exam.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">body</span><span class="p">:</span><span class="w"> </span><span class="l">base64://ZnVuY3Rpb24oY3R4KQ0KaWYgY3R4LmlkZW50aXR5LnRyYWl0cy51c2VyX3R5cGUgPT0gInN0dWRlbnQiIHRoZW4NCiAgZXJyb3IgImNhbmNlbCINCmVsc2UNCiAgew0KICAgICJ0cmFpdHMiOiB7DQogICAgICAiZW1haWwiOiBjdHguaWRlbnRpdHkudHJhaXRzLmVtYWlsDQogICAgfQ0KICB9</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We update the release and test the registration process for an educator account. if the registration ran successfully we will see a document has been created on subscribers table.</p>
<video width="640" height="360" controls>
  <source src="/videos/kratos_webhook.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<h3 id="sending-email">Sending Email</h3>
<p>Can you guess the last missing element of the puzzle ? It&rsquo;s the emailing part, Sending an email when the exam is generated or the student has answered the questions. the knative-sevice will get triggered whenever a message reaches the <code>email-topic</code> we created on the previous steps.</p>
<p>the <code>main.py</code> in the knative service will be composed of 2 functions:</p>
<ul>
<li>get_subscribers: to retrieve emails from the <code>subscribers</code> table.</li>
<li>send_email: will decode the event message and send it to the list of emails we have</li>
</ul>
<p>so here is the code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">email.message</span> <span class="kn">import</span> <span class="n">EmailMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">smtplib</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">HTTPError</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MAILGUN_API_KEY&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_subscribers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize DynamoDB table</span>
</span></span><span class="line"><span class="cl">    <span class="n">table_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGO_TABLE_NAME&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGO_URI&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s2">&#34;exams&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">subscribers</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">subscribers</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">body</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;https://api.mailgun.net/v3/xxxxxxx.mailgun.org/messages&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s2">&#34;api&#34;</span><span class="p">,</span> <span class="n">API_KEY</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;from&#34;</span><span class="p">:</span> <span class="s2">&#34;Excited User &lt;no-reply@enkinineveh.space&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;to&#34;</span><span class="p">:</span> <span class="n">subs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;subject&#34;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;text&#34;</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">body</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">subs</span> <span class="o">=</span> <span class="n">get_subscribers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">send_mail</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span><span class="s2">&#34;HELLO&#34;</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>finally build and push the image and the reference it in <code>values.yaml</code> in addtiontion to passing the enviornment variables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">normal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">BOOTSTRAP_SERVER</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-cluster-kafka-bootstrap.strimzi.svc:9092</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MAILGUN_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="l">xxxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_TABLE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">subscribers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_URI</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;mongodb://databaseAdmin:sHWKYbXRalmNExTMiYr@my-cluster-name-rs0.mongo.svc.cluster.local/admin?replicaSet=rs0&amp;ssl=false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">TOPIC_ARN</span><span class="p">:</span><span class="w"> </span><span class="l">email-topic</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We clearly done setting up everything, I will test the whole process from registring user and receiving verification code, generating an exam and receiving the email when it&rsquo;s ready, answering the questions and getting the scoreboard mail.</p>
<video width="640" height="360" controls>
  <source src="/videos/exam-demo-2.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<h2 id="summary">Summary</h2>
<p>and That&rsquo;s it, we transformed the architecture into a pure open source project.</p>
]]></content:encoded>
    </item>
    <item>
      <title>Transform AWS Exam Generator Architecture to Open Source Part #4: Exam Passing</title>
      <link>//localhost:1313/posts/transform-aws-4/</link>
      <pubDate>Mon, 12 Aug 2024 14:40:10 +0100</pubDate>
      <guid>//localhost:1313/posts/transform-aws-4/</guid>
      <description>Brief Description In this article, we create the passing part of the exam, the architecture is composed of:
kubernetes service for Taking Exam UI. Knative service for taking exams. MongoDb for storing student answers. KafkaConnect to capture changed data on MongoDb and move it to a KafkaTopic. Knative service for calculating the scoreboard and send it into a topic. We will follow the same approach in the previous article, we tackle dependency-free services first.</description>
      <content:encoded><![CDATA[<h2 id="brief-description">Brief Description</h2>
<p>In this article, we create the passing part of the exam, the architecture is composed of:</p>
<ul>
<li>kubernetes service for Taking Exam UI.</li>
<li>Knative service for taking exams.</li>
<li>MongoDb for storing student answers.</li>
<li>KafkaConnect to capture changed data on MongoDb and move it to a KafkaTopic.</li>
<li>Knative service for calculating the scoreboard and send it into a topic.</li>
</ul>
<p>We will follow the same approach in the previous article, we tackle dependency-free services first. the the UI app will require the knative service and mongo to work, so we start with knative service and mongo and then we move into UI and finally the Kafka connect integration with mongodb and knative.</p>
<h2 id="knative-fn">Knative Fn</h2>
<p>We download the function <a href="https://raw.githubusercontent.com/aws-samples/serverless-exam-generator-from-your-lecture-amazon-bedrock/main/TakeExamFn/take_exam.py">take_exam.py</a> file, create a FastAPI wrapper but this time there is no event instead the function is called directly from the UI.</p>
<p>If we inspect the <strong>take_exam.py</strong> code, we can see it’s expecting a <strong>queryStringParameters</strong> dict inside the event and inside it a string called: <strong>object_name</strong> which will be referencing the exam file.</p>
<p>So here is the <strong>app.py</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.get</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">intercept_event</span><span class="p">(</span><span class="n">object_name</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">object_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;queryStringParameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;object_name&#34;</span><span class="p">:</span> <span class="n">object_name</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;queryStringParameters&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="o">=</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Cool, now we build, push</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker buildx build -t gitea.enkinineveh.space/gitea_admin/exam-take-fn:v1 . --push
</span></span></code></pre></td></tr></table>
</div>
</div><p>and reference the image and we don’t forget the Minio environment values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">gitea.enkinineveh.space/gitea_admin/exam-take-fn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Overrides the image tag whose default is the chart appVersion.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;v1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">normal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">BUCKET_NAME</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;exams&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">AWS_ACCESS_KEY_ID</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;minio&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;minio123&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">AWS_ENDPOINT_URL_S3</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://minions-hl.minio-tenant:9000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After adding the helm chart to helmfile release and apply it, we inspect the knative service to get the ingress URL, which will be used by the frontend later.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get kservice exam-taking-fn -n exam
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                          URL                                                            LATESTCREATED                       LATESTREADY                         READY   REASON
</span></span><span class="line"><span class="cl">exam-taking-fn   http://exam-taking-fn.exam.svc.cluster.local   exam-taking-fn-00001   exam-taking-fn-00001   True
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mongodb">Mongodb</h2>
<p>Next part is Mongodb, we will use the percona operator for managing the MongoDb cluster</p>
<p>first start by installing the chart</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">repositories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">percona</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">https://percona.github.io/percona-helm-charts/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">releases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">percona-operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">percona/psmdb-operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then we copy paste the following script to deploy a Cluster with 3 replicas across nodes “<a href="http://kubernetes.io/hostname">kubernetes.io/hostname</a>” and a 1Gb of storage for now:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">psmdb.percona.com/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PerconaServerMongoDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">mongo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">percona/percona-server-mongodb:4.4.6-8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replsets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rs0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeSpec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Rerun <strong>helmfile apply</strong>, wait a few minutes and here the cluster status is <strong>ready,</strong> and the <strong>endpoint</strong> for kubernetes internal access.</p>
<p><img loading="lazy" src="/img/mongo-cluster.png" alt="percona cluster status"  />
</p>
<p>But for database access we need credentials, which will be found on a secret named <strong>mongodb-cluster-secret</strong>.</p>
<h2 id="frontend-ui-app">Frontend UI app</h2>
<p>As both dependencies: exam-take function and mongodb are created, we’re able to deploy the exam-take frontend now.</p>
<p>Having a look at the <a href="%5Bhttp://%5D(https://github.com/aws-samples/serverless-exam-generator-from-your-lecture-amazon-bedrock/blob/main/frontend/take-exam-fe/quiz.py)">frontend code</a>, the application needs a:</p>
<p><strong>API_GATEWAY_URL</strong> which is in our case the knative service url we got before:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">normal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">API_GATEWAY_URL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://exam-taking-fn.exam.svc.cluster.local&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">API_GATEWAY_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;API_GATEWAY_URL&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A token to decode the authenticated user’s email, we will escape this part for now as it requires an authenticated service, we will pass a static email for every student.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># headers = _get_websocket_headers()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># token = headers.get(&#39;X-Amzn-Oidc-Data&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># parts = token.split(&#39;.&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># if len(parts) &gt; 1:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     payload = parts[1]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#     # Decode the payload</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     decoded_bytes = base64.urlsafe_b64decode(payload + &#39;==&#39;)  # Padding just in case</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     decoded_str = decoded_bytes.decode(&#39;utf-8&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     decoded_payload = json.loads(decoded_str)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#     # Extract the email</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     email = decoded_payload.get(&#39;email&#39;, &#39;Email not found&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     print(email)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># else:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(&#34;Invalid token&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">email</span> <span class="o">=</span> <span class="s2">&#34;tunis@gmail.com&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And to save the answers, a Dynamodb was used. We replaced the code with MongoClient and passed the host and table name as environment variables.</p>
<p>quiz.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">save_quiz_results</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize DynamoDB table</span>
</span></span><span class="line"><span class="cl">    <span class="n">table_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MONGO_TABLE_NAME&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGO_URI&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s1">&#39;exams&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>values.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">normal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_URI</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;mongodb://databaseAdmin:sHWKYbXRalmNExTMiYr@my-cluster-name-rs0.mongo.svc.cluster.local/admin?replicaSet=rs0&amp;ssl=false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_TABLE_NAME</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;score&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We add the pymongo package in the requirements.txt file, then build and push.</p>
<p>We do the same as the generation front-end app, reference the image, change port, enable ingress, specify websocket service and done</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker buildx build -t gitea.enkinineveh.space/gitea_admin/exam-take-frontend . --push
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">gitea.enkinineveh.space/gitea_admin/exam-take-frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Overrides the image tag whose default is the chart appVersion.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;v1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8501</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/proxy-connect-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3600s&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/proxy-read-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3600s&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/client-max-body-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/proxy-buffering</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/websocket-services</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend-charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">ImplementationSpecific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend-charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">8501</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">enkinineveh.space-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="l">exam-taking-frontend.enkinineveh.space</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Add the chart into helmfile, apply it</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">releases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-generation-frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./frontend/exam-generation-app/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;exam&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend</span><span class="w"> </span><span class="c"># we added this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./frontend/exam-taking-app/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;exam&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-generation-fn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./knative/ExamGenFn/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;exam&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-fn</span><span class="w"> </span><span class="c"># we added this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./knative/ExamTakeFn/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;exam&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and we can access the UI Now.
<img loading="lazy" src="/img/front-exam-passing.png" alt="front exam passing"  />
</p>
<p>Now we try the whole thing, remove past files and start, upload the supposed test pdf file, wait for generation, check the taking-exam app, we see it listed the exam, we click, and it generates a form, we answer and voila.</p>
<p>Finally let’s check the mongodb table for the answers, we list documents inside the score <strong>table,</strong> everything looks good.</p>
<p>here is a demo for more visual pleasing experience</p>
<video width="640" height="360" controls>
  <source src="/videos/exam-taking-demo.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<h2 id="kafka-connect--function">Kafka Connect &amp; Function</h2>
<p>One of the reasons I choose Kafka besides its seamless integration with knative, is the ability to capture data changes (CDC) from other sources and forward it to topics, this ability is called Kafka Connect.</p>
<p>Kafka Connect is a tool for scalably and reliably streaming data between Apache Kafka® and other data systems. If we want to capture data the time it gets added into Mongodb, we must configure the Kafka Connect to use the Mongodb Connector which internally listens for Mongodb CDC.</p>
<p>Kafka Connect will be deployed as a separate Cluster but under the same kubernetes cluster of course</p>
<p><img loading="lazy" src="/img/kafka-connect-arch.png" alt="kafka connect cluster"  />
</p>
<p>Here is the yaml <strong>kafka-connect.yaml</strong>  for creating the cluster:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kafka.strimzi.io/v1beta2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaConnect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">connect-cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">strimzi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strimzi.io/use-connector-resources</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gitea.enkinineveh.space/gitea_admin/connect-debezium:v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bootstrapServers</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-cluster-kafka-bootstrap.strimzi.svc:9092</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">group.id</span><span class="p">:</span><span class="w"> </span><span class="l">connect-cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">offset.storage.topic</span><span class="p">:</span><span class="w"> </span><span class="l">connect-cluster-offsets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config.storage.topic</span><span class="p">:</span><span class="w"> </span><span class="l">connect-cluster-configs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status.storage.topic</span><span class="p">:</span><span class="w"> </span><span class="l">connect-cluster-status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">inline</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loggers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connect.root.logger.level</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;INFO&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>bootstrapServers</strong> for connecting to the Kafka server.</li>
<li><strong>group.id</strong> unique id for defining group of workers</li>
<li>And those config are internal topic for managing connector and task status, configuration, storage data</li>
<li>And the most important property is <strong>image</strong>, the image must be from strimzi/Kafka, and it should add the mongodb connector under plugins folder to be used later by connectors, I deployed my own image , you can find the code in the repo.</li>
<li>Setting <strong>use-connector-resources</strong> to true enables KafkaConnectors to create, remove, and reconfigure connectors</li>
</ul>
<p>The last interesting part now, is adding the connector:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kafka.strimzi.io/v1beta2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaConnector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongodb-source-connector-second</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">strimzi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strimzi.io/cluster</span><span class="p">:</span><span class="w"> </span><span class="l">connect-cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">io.debezium.connector.mongodb.MongoDbConnector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasksMax</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mongodb.connection.string</span><span class="p">:</span><span class="w"> </span><span class="l">mongodb://databaseAdmin:sHWKYbXRalmNExTMiYr@my-cluster-name-rs0.mongo.svc.cluster.local/admin?replicaSet=rs0&amp;ssl=false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">topic.prefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;mongo-trigger-topic&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">database.include.list</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;exams&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">collection.include.list</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;score&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We specify the class for <strong>MongoDbConnector</strong> plugin, and the last properties are needed for mongodb, here the <strong>topic prefix</strong> is “mongo-trigger-topic”, but we must create a topic with following name, <strong>mongo-trigger-topic.exam.score, why?</strong></p>
<p>Because KafkaConnector use this format: prefix.db.colletion to forward events, means if we add record in score collection the topic name should, &lt;topic.prefix&gt;.exam.score</p>
<p>So here is the code for topic creation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kafka.strimzi.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaTopic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-trigger-topic.exams.score</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">strimzi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strimzi.io/cluster</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kafka-cluster&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">partitions</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>One thing to notice is the event format that will be forwarded from kafka connect, here is an example of the format:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;payload&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;before&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;after&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;_id\&#34;: {\&#34;$oid\&#34;: \&#34;66a279b8f98a9d0379570575\&#34;},\&#34;email\&#34;: \&#34;tunisia@gmail.com\&#34;,\&#34;score\&#34;: 0,\&#34;result\&#34;: \&#34;failed\&#34;,\&#34;details\&#34;: [{\&#34;question\&#34;: \&#34;Which country of those countries located in balkans ?\&#34;,\&#34;user_answer\&#34;: \&#34;Germany\&#34;,\&#34;correct_answer\&#34;: \&#34;Romania\&#34;,\&#34;is_correct\&#34;: false}]}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;updateDescription&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;2.7.0.Final&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;connector&#34;</span><span class="p">:</span> <span class="s2">&#34;mongodb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;email-topic&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ts_ms&#34;</span><span class="p">:</span> <span class="mi">1721924024000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;snapshot&#34;</span><span class="p">:</span> <span class="s2">&#34;false&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;db&#34;</span><span class="p">:</span> <span class="s2">&#34;exams&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sequence&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ts_us&#34;</span><span class="p">:</span> <span class="mi">1721924024000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ts_ns&#34;</span><span class="p">:</span> <span class="mi">1721924024000000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;collection&#34;</span><span class="p">:</span> <span class="s2">&#34;score&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ord&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;lsid&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;txnNumber&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wallTime&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;op&#34;</span><span class="p">:</span> <span class="s2">&#34;c&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ts_ms&#34;</span><span class="p">:</span> <span class="mi">1721924024568</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;transaction&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>as we&rsquo;re adding a new data the <code>before</code> property is empty and the <code>after</code> should contains the persisted data.</p>
<p>From the architecture you may notice we need a function to consume the stored events in <strong>mongo-trigger-topic.exam.score.</strong> The code is using <strong>SNS and DynamoDb</strong> we replace them with Kafka and mongo.
We start by initialising the KafkaProducer for sending to email Topic. The <code>dynamodb_to_json</code> function will be replaced by mongodb_to_json.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaProducer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">producer</span> <span class="o">=</span> <span class="n">KafkaProducer</span><span class="p">(</span><span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;KAFKA_BOOTSTRAP_SERVER&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Utility function to convert DynamoDB item to regular JSON</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mongodb_to_json</span><span class="p">(</span><span class="n">mongo_item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mongo_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we remove the for loop as knative doesn’t use batching stream and replaceit with a code to get event data from ‘after’ property and  at the end we send messsage to Email Topic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">topic_arn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;EMAIL_TOPIC_ARN&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">image</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;payload&#39;</span><span class="p">][</span><span class="s1">&#39;after&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert DynamoDB JSON to regular JSON</span>
</span></span><span class="line"><span class="cl">    <span class="n">item_json</span> <span class="o">=</span> <span class="n">mongodb_to_json</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Format the message as a score card</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="n">format_score_card</span><span class="p">(</span><span class="n">item_json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">producer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">topic_arn</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error sending Kafka notification: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;statusCode&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="s1">&#39;Lambda executed successfully!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>as the Kafka Connector will persist the added data into a topic, we should create a KafkaSource to consume it and forward it to the mongo function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">sources.knative.dev/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-source</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumerGroup</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bootstrapServers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {{<span class="w"> </span><span class="l">.Values.env.normal.KAFKA_BOOTSTRAP_SERVER }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">topics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {{<span class="w"> </span><span class="l">.Values.env.normal.SOURCE_TOPIC_ARN }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumers</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sink</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ref</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">serving.knative.dev/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">include &#34;charts.fullname&#34; . }}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and finally pass environment variables to helm values.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">normal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">KAFKA_BOOTSTRAP_SERVER</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-cluster-kafka-bootstrap.strimzi.svc:9092</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">SOURCE_TOPIC_ARN</span><span class="p">:</span><span class="w"> </span><span class="l">mongo-trigger-topic.exams.score</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">EMAIL_TOPIC_ARN</span><span class="p">:</span><span class="w"> </span><span class="l">email-topic</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now let’s test the entire process, we first open a side terminal for watching email-topic data.
Visit the frontend app, select an exam, answer the questions, wait for second and here is the data sent to email-topic.</p>
<video width="640" height="360" controls>
  <source src="/videos/take-exam-front-demo.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<h2 id="conclusion">Conclusion</h2>
<p>Now, we finished both parts, the generation and the taking of the exam parts, we will move into securing the access to authenticated accounts and later send notification to educator about student scores.</p>
]]></content:encoded>
    </item>
    <item>
      <title>Transform AWS Exam Generator Architecture to Open Source Part #3: Exam Generation</title>
      <link>//localhost:1313/posts/transform-aws-3/</link>
      <pubDate>Mon, 12 Aug 2024 14:40:08 +0100</pubDate>
      <guid>//localhost:1313/posts/transform-aws-3/</guid>
      <description>Brief description In this part we should talk about:
Kafka topics and difference of deploying between zookeeper and kraft. Create Minio cluster and k8s jobs for adding event notification Knative installation and the invocation with Kafka topics. Hosting of generate-exam frontend in k8s services with ingress, subdomain and reference the WebSocket service. Current Stack I have a K8s cluster composed of three nodes (1 master, 2 control plane) with Talos as the running OS, MetalLB deployed as a load balancer combined with Nginx (nginx.</description>
      <content:encoded><![CDATA[<h2 id="brief-description">Brief description</h2>
<p>In this part we should talk about:</p>
<ol>
<li>Kafka topics and difference of deploying between zookeeper and kraft.</li>
<li>Create Minio cluster and k8s jobs for adding event notification</li>
<li>Knative installation and the invocation with Kafka topics.</li>
<li>Hosting of generate-exam frontend in k8s services with ingress, subdomain and reference the WebSocket service.</li>
</ol>
<h2 id="current-stack">Current Stack</h2>
<p>I have a K8s cluster composed of three nodes (1 master, 2 control plane) with <code>Talos</code> as the running OS, <code>MetalLB</code> deployed as a load balancer combined with <code>Nginx</code> (nginx.io) as an ingress controller.</p>
<p>Ingress hosts that we will see are mapped to my <code>Cloudflare</code> domain(enkinineveh.space) secured with TLS certs generated using <code>cert-manager</code> and <code>letsencrypt</code>. One side note is that am using <a href="https://github.com/emberstack/kubernetes-reflector">reflector</a> to share TLS secret into other namespaces.</p>
<p><code>Helm</code> is my favorite tool for deploying resources, <code>Helmfile</code> in case of deploying multiple charts, and <code>k9s</code> for navigating resources.</p>
<p><code>Gitea</code> is my baby GitHub and <code>CNPG</code> is the default database operator.</p>
<p>here is the repo of current project: <img loading="lazy" src="https://github.com/hamzabouissi/exam-architecture" alt="Github"  />
</p>
<h2 id="introduction">Introduction</h2>
<p>The processing phase is divided into 2 parts: the generation and the passing of the exam.</p>
<p>The generation part is composed of 5 key elements: frontend UI, Minio, Kafka topics, Knative, Bedrock.</p>
<p>When you create an architecture, you must tackle the dependency-free component first, here as an example, for Minio to send notifications it needs a destination in our case it means a topic, and for Knative to get triggered it also needs a source, a topic also, so that leads to Kafka being the first element to create followed by Minio and Knative.</p>
<p>For installing packages in Kubernetes, Helm is my love language, but to deploy multiple charts together helmfile is the get-go, because it assembles charts and deploys them as a single stack.</p>
<h2 id="kafka">Kafka</h2>
<p>Now to deploy a Kafka cluster, we need an operator to handle all the heavy and tedious tasks of managing the cluster, which will lead us into Strimzi.</p>
<p>Strimzi offers a way to run an Apache Kafka cluster on Kubernetes in various deployment configurations, before deploying we must understand the different architecture Kafka comes with.</p>
<p>Kafka have two deployment methods: kraft and zookeeper, the zookeeper method was creating a separate controller for managing metadata that can leads into burden or latency during heavy load environment, in the other side kraft managed to introduce a new method of handling the metadata within Kafka itself.</p>
<p><img loading="lazy" src="https://images.ctfassets.net/gt6dp23g0g38/7gQZn9CnRAT60NeyYBYflL/b144fee6dad28ce97c3e91e6d09d1167/20230616-Diagram-KRaft.jpg" alt="kafka architecture"  />
</p>
<p>From my experience, as we do not have that much of workload, deploying Kafka with zookeeper is sufficient, but for more up to date approach we will deploy the cluster with kraft mode</p>
<p>Internally Kafka is composed of multiple components, which are: producer, consumer, broker, topics and partitions.</p>
<p>To understand the components better, let’s take the generation phase as an example.</p>
<p>Producers are the event emitter, like Minio bucket notification.</p>
<p>Consumers are the event receiver, Knative function is the case, as it consumes the events the moment they reach the topic.</p>
<p>Broker is the connection point between the producer and the consumer, topics on the other side are subcomponents of the broker. As best practice each topic should handle a single goal.</p>
<p>Now Let’s start with installing the operator first, I found the documentation highly informative to starts with.</p>
<p>Installing the operator with kraft mode, will require other feature gates like: <strong>KafkaNodePool</strong>, <strong>UseKraft</strong> and <strong>UnidirectionalTopicOperator</strong>, we add those values into featureGate property in <strong>strimzi-values.yaml</strong> file</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">featureGates</span><span class="p">:</span><span class="w"> </span><span class="l">+UseKRaft,+KafkaNodePools,+UnidirectionalTopicOperator</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>we create a a repository and a release inside the helmfile.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">repositories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">https://strimzi.io/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">releases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-opertor/strimzi-kafka-operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./kafka-values.yaml</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and then run</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helmfile apply 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now our operator is ready, we continue into deploying <strong>KafkaNodePool</strong> and <strong>Kraft Cluster</strong></p>
<p>KafkaNodePool is an essential part for the kraft mode cluster, because it defines a set of node pools to install kafka cluster on and has multiple configurations like number of replicas, roles of nodes, storage configuration, resource requirements, etc…</p>
<p>Here is the yaml file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kafka.strimzi.io/v1beta2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaNodePool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">broker_controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strimzi.io/cluster</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">broker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">jbod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">persistent-claim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deleteClaim</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We defined 3 nodes, a storage of 10Gi for the whole pool and  each node have 2 roles <strong>broker</strong> and <strong>controller</strong>.</p>
<p>Good, let’s initialise the kraft cluster on those nodes, here is the yaml:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kafka.strimzi.io/v1beta2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Kafka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">strimzi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strimzi.io/node-pools</span><span class="p">:</span><span class="w"> </span><span class="l">enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strimzi.io/kraft</span><span class="p">:</span><span class="w"> </span><span class="l">enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kafka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">3.7.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The replicas field is required by the Kafka CRD schema while the KafkaNodePools feature gate is in alpha phase.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># But it will be ignored when Kafka Node Pools are used</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">plain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9092</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">internal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tls</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9093</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">internal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tls</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">offsets.topic.replication.factor</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transaction.state.log.replication.factor</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transaction.state.log.min.isr</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">default.replication.factor</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">min.insync.replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The storage field is required by the Kafka CRD schema while the KafkaNodePools feature gate is in alpha phase.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># But it will be ignored when Kafka Node Pools are used</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">jbod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">persistent-claim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deleteClaim</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># The ZooKeeper section is required by the Kafka CRD schema while the UseKRaft feature gate is in alpha phase.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># But it will be ignored when running in KRaft mode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">zookeeper</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">persistent-claim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">10Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">deleteClaim</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entityOperator</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">userOperator</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">topicOperator</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>topicOperator and userOperator</strong> are for managing topics and user, <strong>Zookeeper</strong> definition is needed but it will be ignored later, and cluster is exposing two ports for TLS/Non-TLS Connection.</p>
<p>As we talked before the Minio Cluster will require a destination topic for sending bucket notifications(events), let’s create a one:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kafka.strimzi.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaTopic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-generator-topic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strimzi.io/cluster</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kafka-cluster&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">partitions</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>I found the 1 replicas with 3 partition is a good combination for latency and throughput(parallelism)</p>
<h2 id="minio--bucket-notification">Minio &amp; Bucket Notification</h2>
<p>The Minio Cluster Deployment process is the same as Kafka, We install operator first:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">repositories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">minio-operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">https://operator.min.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">releases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">minio-operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">minio-operator/operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">minio-operator</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then we create a Minio Tenant (same as cluster), start by downloading the default <strong>values.yaml</strong> and changing few properties to match our needs:</p>
<ul>
<li>First, add a bucket named <strong>exams</strong> to get created when the tenant initialised:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">buckets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exams</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">objectLock</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Change <strong>pools.server=1</strong> because a standalone server is enough</li>
<li>As the Minio will be accessed internally in Kubernetes, we <strong>disable ingress</strong> and if we need to access the console we port-forward the service.</li>
<li>Secrets: we use simple <strong>access key</strong> and <strong>secret key</strong> in my case: <strong>minio</strong> and <strong>minio123</strong></li>
</ul>
<p>then add the chart and values to helmfile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">minio-tenant</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">minio-operator/tenant</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">minio-tenant</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./minio-tenant-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">minio-operator</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We check the pods, and here is the tenant deployed.</p>
<p><img loading="lazy" src="/img/k9s-minio-tenant.png" alt="minio-tenant"  />
</p>
<p>To test things out Let’s forward the console port and access it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> kpf -n Minio-operator services/console 9090:9090
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/img/minio-console.png" alt="minio-console"  />
</p>
<p>It asked for the JWT, which will be retrieved with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get secret/console-sa-secret -n minio-operator -o JSON<span class="p">|</span> jq -r <span class="s1">&#39;.data.token&#39;</span> <span class="p">|</span> base64 -d
</span></span></code></pre></td></tr></table>
</div>
</div><p>Cool, the tenant is working, and the bucket was created successfully</p>
<p><img loading="lazy" src="/img/minio-bucket.png" alt="minio-bucket"  />
</p>
<p>But we’re missing the notification side when uploading an object. To add Kafka endpoint as the notification destination, we will use the configuration command: <strong>mc</strong></p>
<p>Here is the configuration script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># First Part</span>
</span></span><span class="line"><span class="cl">mc config host add dc-minio http://minions-hl.minio-tenant:9000 minio minio123<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mc admin config get dc-minio notify_kafka<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mc admin config <span class="nb">set</span> dc-minio notify_kafka:primary <span class="se">\\</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">brokers</span><span class="o">=</span><span class="s2">&#34;kafka-cluster-kafka-bootstrap.strimzi.svc:9092&#34;</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">topic</span><span class="o">=</span><span class="s2">&#34;exam-generator-topic&#34;</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">tls_skip_verify</span><span class="o">=</span><span class="nb">true</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">enabled</span><span class="o">=</span>on<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mc admin service restart dc-minio<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;finish restart&#34;</span><span class="p">;</span> sleep 10s<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Second Part</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mc event add --event <span class="s2">&#34;put&#34;</span> --prefix exams dc-minio/exams arn:minio:sqs::primary:kafka <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;setup event bridging&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first part is adding the <strong>Minio host</strong>, <strong>Kafka bootstrap server</strong> and <strong>destination topic</strong>.</p>
<p>The second part is adding the event hook for the <strong>“put”</strong> command targeted for <strong>exams folders inside exams buckets</strong>.</p>
<p>We wrap the above code into a Kubernetes job and run it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">configure-bucket-notification</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">minio-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">minio/mc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">              mc config host add dc-minio http://minions-hl.minio-tenant:9000 minio minio123;
</span></span></span><span class="line"><span class="cl"><span class="sd">              mc admin config get dc-minio notify_kafka;
</span></span></span><span class="line"><span class="cl"><span class="sd">              mc admin config set dc-minio notify_kafka:primary \
</span></span></span><span class="line"><span class="cl"><span class="sd">                brokers=&#34;kafka-cluster-kafka-bootstrap.strimzi.svc:9092&#34; \
</span></span></span><span class="line"><span class="cl"><span class="sd">                topic=&#34;exam-generator-topic&#34; \
</span></span></span><span class="line"><span class="cl"><span class="sd">                tls_skip_verify=true \
</span></span></span><span class="line"><span class="cl"><span class="sd">                enabled=on;
</span></span></span><span class="line"><span class="cl"><span class="sd">              mc admin service restart dc-minio;
</span></span></span><span class="line"><span class="cl"><span class="sd">              echo &#34;finish restart&#34;; sleep 10s;
</span></span></span><span class="line"><span class="cl"><span class="sd">              mc event add --event &#34;put&#34; --prefix exams dc-minio/exams arn:minio:sqs::primary:kafka ;
</span></span></span><span class="line"><span class="cl"><span class="sd">              echo &#34;setup event bridging&#34;;</span><span class="w">              
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Let’s test things out, we start a Kafka consumer for the <strong>exam-generator-topic</strong> topic, then we try uploading a sample file, we wait and an <strong>ObjectCreated</strong> event will appear.</p>
<video width="640" height="360" controls>
  <source src="/videos/minio-event-kafka.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<p>you may notice it’s S3 compatible, that will help us for not changing the code of Knative function to adapt Minio events.</p>
<h2 id="knative--kafkasource">Knative &amp; KafkaSource</h2>
<p>The Knative architecture holds multiple components, so we will give a general overview of the architecture without going into much details. Knative is divided into two major components: serving and eventing.</p>
<p>The serving part handles managing serverless workload inside the cluster, here is the request flow of HTTP requests to an application which is running on Knative Serving.</p>
<p><img loading="lazy" src="https://knative.dev/docs/serving/images/request-flow.png" alt="knative-request-flow"  />
</p>
<p>The eventing part is a collection of APIs that enable you to use an <a href="https://en.wikipedia.org/wiki/Event-driven_architecture">event-driven architecture</a> with your applications. This part handles event listening on brokers and delivering it to SINKS (knative services)</p>
<p><img loading="lazy" src="https://knative.dev/docs/eventing/images/mesh.png" alt="knative-eventing"  />
</p>
<p>As we finished explaining the core architecture, let’s move into installing Knative. The problem is that Knative doesn’t have a helm chart, so we will create one.</p>
<p>First to install the Serving part, two yaml files are needed: <strong>serving-crds, serving-core</strong></p>
<p>Let’s create a helm chart with:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm create knative/core
</span></span></code></pre></td></tr></table>
</div>
</div><p>Delete all the files in templates folders except <strong>_helpers.tpl</strong> then download the two yaml files and place them inside templates folder.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/knative/serving/releases/download/knative-v1.15.2/serving-crds.yaml -o serving-crds.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/knative/serving/releases/download/knative-v1.15.2/serving-core.yaml -o serving-core.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Need another file to integrate knative with istio</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/knative/net-istio/releases/download/knative-v1.15.1/net-istio.yaml -o net-istio.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Good, let’s add the chart to helmfile and install it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w"> </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">knative-core</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./knative/core</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After installation, the above components will be created, and an ingress-gateway for serving Knative services(functions).</p>
<p><img loading="lazy" src="/img/knative-pods.png" alt="knative-pods-k9s"  />
</p>
<p>Each Knative service must have a DNS to map to, am using Cloudflare to manage my domain.
We retrieve the Istio ingress gateway IP address</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --namespace istio-system get service istio-ingressgateway
</span></span></code></pre></td></tr></table>
</div>
</div><p>and create an A record referencing “kn-function” subdomain</p>
<p><img loading="lazy" src="/img/cloudflare.png" alt="cloudflare image"  />
</p>
<p>Then we tell knative to serve services with the new domain</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl patch configmap/config-domain <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace knative-serving <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --type merge <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --patch <span class="s1">&#39;{&#34;data&#34;:{&#34;kn-functions.enkinineveh.space&#34;:&#34;&#34;}}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Good, the serving component is ready, let&rsquo;s move into the event part.</p>
<p>The event part is the same as the serving with few added steps,
We first install the 2 yaml files: <strong>CRDs</strong> and <strong>Core</strong>, then we move into <strong>Knative source for Apache Kafka</strong>.</p>
<p>The KafkaSource reads messages stored in an existing <a href="https://kafka.apache.org/">Apache Kafka</a> topics, and sends those messages as CloudEvents through HTTP to its configured sink(function)</p>
<p>KafkaSource composed of <strong>controller</strong> and <strong>data plane.</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/knative-extensions/eventing-Kafka-broker/releases/download/knative-v1.15.0/eventing-Kafka-controller.yaml -o eventing-kafka-broker.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/knative-extensions/eventing-kafka-broker/releases/download/knative-v1.15.1/eventing-kafka-source.yaml -o eventing-kafka-source.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>For testing purpose now, we can deploy the below code to create an event display service for displaying received events and KafkaSource to link the topic with Knative service.</p>
<p>service.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">serving.knative.dev/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">event-display</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">exam</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/knative-releases/knative.dev/eventing/cmd/event_display</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>kafka-source.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">sources.knative.dev/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-source</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">exam</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumerGroup</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bootstrapServers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">kafka-cluster-kafka-bootstrap.strimzi.svc:909</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">topics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">exam-generator-topic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumers</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sink</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ref</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">serving.knative.dev/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">event-display</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">exam</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The source needs the Kafka server connection URL, topic and the service name to send events to.</p>
<h2 id="knative-service-building">Knative Service Building</h2>
<p>But instead of an event display service, we need our exam generated service, luckily the AWS project has the code of the service.</p>
<p>We download the file, and we can see it’s using SNS and bedrock; two packages aren’t essential. Because SNS will be replaced by Kafka, and bedrock will be removed as we will use a static question for simplicity</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sns = boto3.client(&#34;sns&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">producer</span> <span class="o">=</span> <span class="n">KafkaProducer</span><span class="p">(</span><span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;KAFKA_BOOTSTRAP_SERVER&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bedrock = HelperBedrock()</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>and because we removed bedrock, we will pass a bunch of static questions</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># response = bedrock.get_response(file, template_instruction)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># response = bedrock.get_response(response, template_formatted)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># json_exam = file_helper.convert_to_json_in_memory(response)</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Write the JSON data to the in-memory stream</span>
</span></span><span class="line"><span class="cl">    <span class="n">questions</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;question&#34;</span><span class="p">:</span> <span class="s2">&#34;Which country of those countries located in balkans ?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;options&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Romania&#34;</span><span class="p">,</span> <span class="s2">&#34;Germany&#34;</span><span class="p">,</span> <span class="s2">&#34;Croatia&#34;</span><span class="p">,</span> <span class="s2">&#34;Czech&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;correct_answer&#34;</span><span class="p">:</span> <span class="s2">&#34;Romania&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;question&#34;</span><span class="p">:</span> <span class="s2">&#34;Where Tunisia is located?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;options&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;South America&#34;</span><span class="p">,</span> <span class="s2">&#34;Asia&#34;</span><span class="p">,</span> <span class="s2">&#34;Africa&#34;</span><span class="p">,</span> <span class="s2">&#34;Oceania&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;correct_answer&#34;</span><span class="p">:</span> <span class="s2">&#34;Africa&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># To ensure the content is in the buffer, seek the pointer back to the start of the stream</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>One requirement for the code to work is wrapping it inside an API, FastAPI will get the job done.</p>
<p>Define a single endpoint that receives the event, converts it into JSON and passes it to the main function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">main</span>
</span></span><span class="line"><span class="cl"><span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;API is starting up&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span><span class="n">Request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.get</span><span class="p">(</span><span class="s2">&#34;/health&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">health</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;Hello&#34;</span><span class="p">:</span> <span class="s2">&#34;World&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.post</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">intercept_event</span><span class="p">(</span><span class="n">request</span><span class="p">:</span><span class="n">Request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">main</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></td></tr></table>
</div>
</div><p>The service will need a container image to run, so we create a Dockerfile and requirements.txt for referencing package dependencies like FastAPI,Kafka..etc.</p>
<p>Dockerfile</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># </span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.10</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># </span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /code</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># </span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./requirements.txt /code/requirements.txt<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># </span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install --no-cache-dir -r /code/requirements.txt<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># </span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./ /code/app<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># </span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;fastapi&#34;</span><span class="p">,</span> <span class="s2">&#34;run&#34;</span><span class="p">,</span> <span class="s2">&#34;app/app.py&#34;</span><span class="p">,</span> <span class="s2">&#34;--port&#34;</span><span class="p">,</span> <span class="s2">&#34;80&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>requiremtents.txt</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">boto3
</span></span><span class="line"><span class="cl">fastapi
</span></span><span class="line"><span class="cl">httptools
</span></span><span class="line"><span class="cl">kafka-python
</span></span><span class="line"><span class="cl">langchain
</span></span><span class="line"><span class="cl">langchain-community
</span></span><span class="line"><span class="cl">pdfminer.six
</span></span><span class="line"><span class="cl">pip-chill
</span></span><span class="line"><span class="cl">python-dotenv
</span></span><span class="line"><span class="cl">uvloop
</span></span><span class="line"><span class="cl">watchfiles
</span></span><span class="line"><span class="cl">websockets
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we build the image, push into the registry and reference it inside the Knative service yaml.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> docker buildx build  -t gitea.enkinineveh.space/gitea_admin/exam-gen-fn:v1 . --push
</span></span></code></pre></td></tr></table>
</div>
</div><p>We add the environment variables and secrets inside the value.yaml and create a helper to pass values as key,value into service.yaml and other values will be referenced directly.</p>
<p>The service will be accessed internally by the front, so there is no need for exposing it publicly, we can disable access outside of cluster by adding the following label:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">networking.knative.dev/visibility</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-local</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and the last missing resource <code>KafkaSource</code> will invoke the knative service when a new event reach the topic, let&rsquo;s create one</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">sources.knative.dev/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KafkaSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-source</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumerGroup</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bootstrapServers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {{<span class="w"> </span><span class="l">.Values.env.normal.KAFKA_BOOTSTRAP_SERVER }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">topics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {{<span class="w"> </span><span class="l">.Values.env.normal.SOURCE_TOPIC_ARN }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">consumers</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sink</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ref</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">serving.knative.dev/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">include &#34;charts.fullname&#34; . }}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Cool, now redeploy the service</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helmfile apply
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go to Console, upload a file, we notice a pod has been created from the knative service, wait for a few seconds and a new folder “question_bank” will be created with a JSON file holding the questions.</p>
<h2 id="generation-frontend">Generation Frontend</h2>
<p>Here comes the UI part, we copy the 3 files code from the repo and paste them over.</p>
<p>We will leave the code the same, so let’s build the image and push it to the registry</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker buildx build –t gitea.enkinineveh.space/gitea_admin/exam_generator_front_end . --push
</span></span></code></pre></td></tr></table>
</div>
</div><p>We initialise helm chart and update the values to adjust service needs:</p>
<p>Reference the image inside the values.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">gitea.enkinineveh.space/gitea_admin/exam-take-frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Overrides the image tag whose default is the chart appVersion.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;v1&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>the service should listen on port 8501</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8501</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>to access UI outside of kubernetes, we enable ingress, pass the host we want. One thing I noticed is that streamlit uses websocket for communication, so by adding this label, we tell nginx the websocket service it should use in case of websocket requests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/proxy-connect-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3600s&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/proxy-read-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3600s&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/client-max-body-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/proxy-buffering</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/websocket-services</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend-charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">ImplementationSpecific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-taking-frontend-charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">8501</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">enkinineveh.space-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="l">exam-taking-frontend.enkinineveh.space</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And finally create the environment and secret variable, we don’t forget the helper</p>
<p>values.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">normal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">API_GATEWAY_URL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://exam-taking-fn-exam-take-fn.default.svc.cluster.local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_URI</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;mongodb://databaseAdmin:sHWKYbXRalmNExTMiYr@my-cluster-name-rs0.mongo.svc.cluster.local/admin?replicaSet=rs0&amp;ssl=false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">MONGO_TABLE_NAME</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;score&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>_helper.tpl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-tpl" data-lang="tpl"><span class="line"><span class="cl"><span class="cp">{{</span><span class="o">-</span> <span class="na">define</span> <span class="s2">&#34;helpers.list-env-variables&#34;</span><span class="cp">}}</span><span class="x">
</span></span></span><span class="line"><span class="cl"><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">range</span> <span class="nv">$key</span><span class="o">,</span> <span class="nv">$val</span> <span class="o">:=</span> <span class="o">.</span><span class="na">Values</span><span class="o">.</span><span class="na">env</span><span class="o">.</span><span class="na">normal</span> <span class="cp">}}</span><span class="x">
</span></span></span><span class="line"><span class="cl"><span class="x">- name: </span><span class="cp">{{</span> <span class="nv">$key</span> <span class="cp">}}</span><span class="x">
</span></span></span><span class="line"><span class="cl"><span class="x">  value: </span><span class="cp">{{</span> <span class="nv">$val</span> <span class="cp">}}</span><span class="x">
</span></span></span><span class="line"><span class="cl"><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">end</span><span class="cp">}}</span><span class="x">
</span></span></span><span class="line"><span class="cl"><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">end</span> <span class="cp">}}</span><span class="x">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Pass it in helmfile, apply the chart</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">releases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exam-generation-frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./frontend/exam-generation-app/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;exam&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helmfile apply
</span></span></code></pre></td></tr></table>
</div>
</div><p>we visit the host, and here is the Exam Generation UI</p>
<p><img loading="lazy" src="/img/exam-generation-screen.png" alt="exam generation part"  />
</p>
<p>We Upload another test file and get the green mark for successful upload.</p>
<p><img loading="lazy" src="/img/exam-generation-green.png" alt="exam generation part"  />
</p>
<h2 id="summary">Summary</h2>
<p>As we finished the generation part of the architecture, the next step will focus on adding &ldquo;taking-exam&rdquo; part.</p>
]]></content:encoded>
    </item>
    <item>
      <title>Transform AWS Exam Generator Architecture to Open Source Part #2: Research and Planning</title>
      <link>//localhost:1313/posts/transform-aws-2/</link>
      <pubDate>Mon, 12 Aug 2024 14:40:04 +0100</pubDate>
      <guid>//localhost:1313/posts/transform-aws-2/</guid>
      <description>Replacing services Phase In this article, we will pick this AWS architecture: “a serverless exam generator application for educator,” analyse it and find an open-source alternative solution for each service AWS provides, so if you are interested keep it up if you want to know more.
To give a context of how architecture works: it starts with the educator reaching AWS Cognito to create an account either using social media account or a simple email and password.</description>
      <content:encoded><![CDATA[<h2 id="replacing-services-phase">Replacing services Phase</h2>
<p>In this article, we will pick this AWS architecture: “a serverless exam generator application for educator,” analyse it and find an open-source alternative solution for each service AWS provides, so if you are interested keep it up if you want to know more.</p>
<p>To give a context of how architecture works: it starts with the educator reaching AWS Cognito to create an account either using social media account or a simple email and password. A successful account registration will subscribe the user into SNS to receive notifications.</p>
<p>Then he continues into accessing a front-end application created by python Streamlit hosted on ECS to upload his pdf lecture, when the lecture gets persisted, a lambda function will get invoked to process the persisted file and generate an exam with help of the AI, in this case bedrock.</p>
<p>The exam gets generated and persisted into another folder in the same bucket, lambda will then send a message to user SNS subscription saying, “the exam is ready.”</p>
<p>In other side the students will register for an account, visit the front-end for passing the exam, after they finish answering the questions, the user result will get persisted on a DynamoDB table, and with the help of DynamoDB ability of streaming data, a lambda function will get triggered to calculate the scoreboard of users and send a message to teacher SNS subscription.</p>
<p>Now, after we get a general overview of the architecture let us move into the fun part “replacing the AWS services with open-source ones”.</p>
<p>Here list of the used services and their alternatives:</p>
<ul>
<li>AWS Cognito, to add user signup and sign-in features, also it supports social media integration. A suitable alternative is two open-source projects developed by Ory: Kratos for handling sign-in and signup features with social media integration, while Oathkeeper for authenticating and authorizing incoming requests.</li>
<li>ECS, Elastic container service it offers easy mechanism for deploying container to the cloud, a replacement for that is Kubernetes services because we are hosting our stack on k8s</li>
<li>S3, for storing PDF files, a well-known alternative is Minio, an object storage system and guess what? It has S3 compatibility, so we don’t have to change the code that interact with S3</li>
<li>Lambda, a serverless function that will be spawned in case of an event or a direct communication with API Gateway, A known project for the serverless community is Knative, integrated with Istio and Kafka will get the job for us.</li>
<li>API Gateway for the direct communication with lambda, there are many tools out there that can serve Knative traffic like Kong, ambassador but as we installed “Istio”, the Istio gateway will be enough to get the job.</li>
<li>DynamoDB a fully managed, serverless, key-value NoSQL database, the main case of its existence is storing data and using CDC(change data capture) to invoke a lambda function for processing new insert data, as of this requirements any NoSQL database can get the job done, so we will use mongo managed with Percona operator.</li>
<li>Bedrock, fully managed service that offers a choice of high-performing foundation models (FMs), for this one, am going to ignore it and use a static data.</li>
<li>SNS fully managed Pub/Sub service for A2A and A2P messaging, its core functionality in this architecture is sending emails, so I replaced it with Knative function and Mailgun and then used a MongoDB table(subscribers) for storing educator’s email after signing up.</li>
</ul>
<p>here is the final version of the architecture</p>
<p><img loading="lazy" src="/img/exam-open-source.png" alt="open_source"  />
</p>
<p>As we finish the task of replacing the services, we will move into the practical side of the implementation.</p>
<p>The next articles will be divided into 3 parts: generation of the exam, passing the exam, authentication &amp; notification.</p>
]]></content:encoded>
    </item>
    <item>
      <title>Transform AWS Exam Generator Architecture to Open Source Part #1: Introduction</title>
      <link>//localhost:1313/posts/transform-aws-1/</link>
      <pubDate>Mon, 12 Aug 2024 14:32:49 +0100</pubDate>
      <guid>//localhost:1313/posts/transform-aws-1/</guid>
      <description>Introduction Have you thought of creating an AWS architecture but with open-source projects?
In these articles, we will challenge ourselves and transform this AWS architecture: a serverless exam generator application for educators.
The solution enables educators to instantly create curriculum-aligned assessments with minimal effort. Students can take personalised quizzes and get immediate feedback on their performance.
We will transform and replace each service varying from Cognito, Lambda, DynamoDb, fargate…etc with its open-source counterpart and host it, where?</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Have you thought of creating an AWS architecture but with open-source projects?</p>
<p>In these articles, we will challenge ourselves and transform this AWS architecture: a serverless exam generator application for educators.</p>
<p><img loading="lazy" src="/img/cloud-exam-architecture.png" alt="the architecture diagram"  />
</p>
<p>The solution enables educators to instantly create curriculum-aligned assessments with minimal effort. Students can take personalised quizzes and get immediate feedback on their performance.</p>
<p>We will transform and replace each service varying from Cognito, Lambda, DynamoDb, fargate…etc with its open-source counterpart and host it, where? guessed right, on a Kubernetes cluster.</p>
<p>If you liked the idea, keep it up for next articles.</p>
<p>here is the demo the app</p>
<video width="640" height="360" controls>
  <source src="/videos/exam-demo-2.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

]]></content:encoded>
    </item>
    <item>
      <title>Guardians of hell: hydra kratos oathkeeper</title>
      <link>//localhost:1313/posts/guardians_of_hell/</link>
      <pubDate>Mon, 01 Jul 2024 11:39:57 +0100</pubDate>
      <guid>//localhost:1313/posts/guardians_of_hell/</guid>
      <description>Introduction It&amp;rsquo;s been a nearly 3 months on my journey of learning kubernetes,&amp;hellip;.
One day I came across an architecture of AWS that includes AWS Cognito and ECS, if you have worked with AWS before, you would know that Cognito is a hosted authentication service which handles OAuth2/OIDC for you, To put it in a simpler way, it handles authentication and authorization to your AWS resources and provides different techniques to authenticate variying from Github, Google, etc.</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>It&rsquo;s been a nearly 3 months on my journey of learning kubernetes,&hellip;.</p>
<p>One day I came across an architecture of AWS that includes AWS Cognito and ECS, if you have worked with AWS before, you would know that Cognito is a hosted authentication service which handles OAuth2/OIDC for you, To put it in a simpler way, it handles  authentication and authorization to your AWS resources and provides different techniques to authenticate variying from Github, Google, etc.</p>
<p>Then I asked myself wouldn&rsquo;t there be an open source alternative to that? Something I can play with and maybe apply to my customers&rsquo; on-premise architecture?</p>
<p>Well, I bet it exists.</p>
<h2 id="open-source-solution">Open Source Solution</h2>
<p>It seems the open source community has a lot to offer in the identity management area. A quick Google search or ChatGPT prompt &ldquo;open source identity &amp; access management&rdquo; will display quite a few interesting products. The list is:</p>
<p>Keycloak
Zitadel
FusionAuth
Ory products</p>
<p>My decision was to go with &ldquo;Ory open source products&rdquo;. I quite liked their approach of decoupling the functionalities into separate services (Hydra, Kratos, Oathkeeper) so even if you don&rsquo;t like one of their products, you can replace it with another project. The documentation was quite clear but needed some improvements, and the community was kind of active on both Slack and GitHub.</p>
<p>here is a diagram of ory products</p>
<p><img loading="lazy" src="/img/ory_arch.png" alt="ory_arch"  />
</p>
<h2 id="explain-different-terminologies">Explain Different Terminologies</h2>
<p>I have built as a backend developer an authentication and authorization mechanism integrating google, github ..etc, but this time it was different because am delegating those features into services.</p>
<p>I will be honest with you, learning the different terminologies (Identity management, authorization server, OIDC,Oauth2, policy as code, opaque vs jwt) wasn&rsquo;t that smooth, it took me a lot of time searching through articles and asking chatGPT, until I got my final summary that goes like:</p>
<ul>
<li>OpenId: Is an authentication protocol, it allows an app to log into your social account, getting the desired information(email,username,image) without sharing your secret credentials(password).</li>
<li>Oauth2: After proving user identity, user need somehow sort of permission of what kind of resource <strong>have access to</strong>, that part will be taken by Authorization Server(Oauth2).</li>
<li>OpenId Connect (OIDC): A simple identity layer on top of the OAuth2 protocol, which allows clients to verify the identity of the end-user based on the authentication performed by an authorization server, as well as to obtain basic profile information about the end-user.</li>
<li>Token(Opaque vs JWT): opaque are stored in database and when decoding they don&rsquo;t contains any information, JWT in the otherside in it&rsquo;s form is an user information encrypted with secret key, we use JWT for access tokens and opaque for refresh ones.</li>
<li>JWK:A JSON data structure that represents a cryptographic key, used in cryptographic operations such as encryption and digital signatures. those keys used for validating JWT tokens</li>
<li>Authorization server: This component will handle bothi OpenID and Oauth2 protocols</li>
<li>Identity management: this entity will handle authentication and identifying user identity</li>
<li>Policy Enforcement: This tool will work as proxy in front the app we trying to authenticate/authorize to, It intecept request, validate with authorizattion and then decide if user is allowed or denied.</li>
<li>grant_types: there are 2 different methods authorization_code and client_credentials</li>
<li>First-party app: An application that is developed by the same organization that owns the API or resource server. It is trusted by the resource owner.</li>
<li>Third-party An application developed by an external organization that seeks permission to access resources or APIs owned by a different organization.</li>
</ul>
<h2 id="current-stack">Current Stack</h2>
<p>I have a K8s cluster composed of three nodes (1 master, 2 control plane) with Talos as the running OS, MetalLB deployed as a load balancer combined with Nginx (nginx.io) as an ingress controller.</p>
<p>Ingress hosts that we will see are mapped to my Cloudflare domain(enkinineveh.space) secured with TLS certs generated using cert-manager and letsencrypt. One side note is that am using <a href="https://github.com/emberstack/kubernetes-reflector">reflector</a> to share TLS secret into other namespaces.</p>
<p>Helm is my favorite tool for deploying resources, Helmfile in case of deploying multiple charts, and k9s for navigating resources.</p>
<p>Gitea is my baby GitHub and CNPG is the default database.</p>
<h2 id="mini-project">Mini Project</h2>
<p>To better understand the usability of the Ory products, we will be deploying a mini project composed of:</p>
<ul>
<li>A <strong>private location service</strong> that returns user location.</li>
<li>Publicly accessible <strong>backend to serve the frontend</strong> and connect to private services for fetching data.</li>
<li>Simple frontend for displaying information.</li>
</ul>
<p>Some considerations on Authentication concerns:</p>
<ul>
<li>User registration form must be composed of: Full Name, Email, Phone Number, Password.</li>
<li>Email is unique.</li>
<li><strong>Social login using Google or GitHub</strong> will be a plus. One thing to note here is that we want to redirect users to the registration form in case one of the above fields is not present on the social platform.</li>
</ul>
<p>Some considerations on Authorization concerns:</p>
<ul>
<li>Requests to the location service need <strong>&rsquo;location:read&rsquo;</strong> scope to get authorized.</li>
<li>We need two different clients: one for <strong>internal communication M2M</strong>, the other for communication <strong>between backend and frontend</strong> involving the user but without consent as the frontend is a <strong>first-party app</strong>.</li>
<li>One beneficial step will be <strong>passing the authorized user_id as a custom header</strong>. We may provide <strong>third parties the ability to create OAuth2 apps</strong>. For the moment, we create one for them, but we want the same seamless experience as other platforms, including consent, scopes, and allowing those apps to <strong>access the location service directly as it may become public</strong> in the future.</li>
</ul>
<p><img loading="lazy" src="/img/diagram.png" alt="project diagram"  />
</p>
<h2 id="kratos--custom-ui">Kratos + Custom UI</h2>
<h3 id="introduction-1">Introduction</h3>
<p>At first, when a user tries to access a protected resource, they need to have an account or sign up for a new one and then get a token to send to the protected resource for authorizing their request.</p>
<p>During the phase of login/registration, an identity management system must exist to handle all that, so say welcome to Kratos.</p>
<p>Kratos is an identity management service that will handle all sorts of authentication methods, including login, registration, email verification, password reset, social login, etc.</p>
<p>But Kratos doesn&rsquo;t come with a UI. Instead, it offers integration with existing UIs. You can create your pages with whatever language you like and then just reference the URLs in the Kratos config/selfservice/flows.</p>
<p>I&rsquo;m by no means a frontend developer, so I will use this <a href="https://github.com/ory/kratos-selfservice-ui-node">open source</a> UI project developed by Ory. It has the majority of the functionalities that I need and we will add a couple of changes later.</p>
<h3 id="deploying">Deploying</h3>
<p>kratos has 2 components:</p>
<ul>
<li>Public for serving UI.</li>
<li>Admin for managing identities (users) and modifying Kratos configuration (this component should be kept private for internal resources).</li>
</ul>
<p>To facilitate deployment, we will leverage a Helm chart. A quick Helm install will configure and deploy our resources. Ory has a quite good Helm <a href="https://github.com/ory/k8s/tree/master/helm/charts/kratos">chart</a>. We will download the chart and make a couple of modifications.</p>
<p>First, we will expose the public API, and the obvious approach is using Ingress, so we will change the following code under ingress:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">public</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">kratos.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos-public</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">enkinineveh.space-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">kratos.enkinineveh.space</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Second, kratos needs a database to store identities so we will update &ldquo;config&rdquo;:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dsn</span><span class="p">:</span><span class="w"> </span><span class="l">postgresql://kratos:kratos@cluster-pg-rw.cnpg-system.svc.cluster.local:5432/kratos</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>I created the user and db manually, take note the host is mapped to a local instance(my pg).</p>
<p>all things configured, now let&rsquo;s deploy the chart with modified values</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  kubectl create namespace auth
</span></span><span class="line"><span class="cl">  helm upgrade --install kratos -n auth -f kratos/kratos-values.yaml ory/kratos
</span></span></code></pre></td></tr></table>
</div>
</div><p>To experience full potential of kratos, we need to integrate the UI part.
We clone the project, build it and push to a registry. either you deploy it to remote a registry like docker hub or a local one, am using gitea so that will more secure and easy for me.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  docker buildx build  -t gitea.enkinineveh.space/gitea_admin/kratos-ui:v1 .
</span></span><span class="line"><span class="cl">  docker push gitea.enkinineveh.space/gitea_admin/kratos-ui:v1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now the docker image is ready, let&rsquo;s initialize a local helm chart for the UI.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-BASH" data-lang="BASH"><span class="line"><span class="cl">  helm create charts
</span></span></code></pre></td></tr></table>
</div>
</div><p>move into the values.yaml file and change the repository to the desired image in my case is gitea.enkinineveh.space/gitea_admin/kratos-ui, also don&rsquo;t the forget the tag: v1</p>
<p>you may notice we didn&rsquo;t add a domain or an ingress to access the UI, because for the UI to work it needs to be deployed under the same domain as kratos public, so our approach will be updating the previous chart of kratos and add another path for the kratos-ui.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">public</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nginx.org/rewrites</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;serviceName=kratos-public rewrite=/&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">kratos.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos-ui-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos-public</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">enkinineveh.space-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">kratos.enkinineveh.space</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>You can see I created another path &ldquo;/app&rdquo; for kratos-public, and leave the default &ldquo;/&rdquo; for kratos-ui.</p>
<p>One thing to notice is the annotation, I rewrite requests going to /app to / on kratos-public which means if I request /app/login on <strong>kratos.enkinineveh.space</strong> it will be forwared as /login in kratos-public.</p>
<p>Another thing to do is kratos need to reference the deployed UI, the known approach is updating kratos/config/flows by adding the different paths, in our case it will be like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flows</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">error</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/error</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">login</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/login</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verification</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/verification</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">registration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/registration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">settings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ui_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/settings</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Cool, everything is configured let&rsquo;s install the chart but this time using helmfile as we have 2 charts to maintain</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">helmDefaults</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">createNamespace</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">releases</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">./kratos-ui/charts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kratos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">ory/kratos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">kratos/kratos-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">kratos-ui</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>To apply the changes and test the UI run <code>helmfile apply</code></p>
<h3 id="identity">Identity</h3>
<p>After the UI get deployed we will try create an identity, we can use the private api for admin service, but for this case we will leverage the UI part.</p>
<p>Heads up into kratos.enkinineveh.space and click on the signup button, registration form will appear contains email and password and if notice the url appended flow query params(was added by kratos itself).</p>
<p>We will extend the form and add 2 other fields(full_name, phone_number) by updating the identity.schemas param, here is the updated version:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;$id&#34;</span><span class="p">:</span> <span class="s2">&#34;https://schemas.ory.sh/presets/kratos/identity.email.schema.json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;$schema&#34;</span><span class="p">:</span> <span class="s2">&#34;http://json-schema.org/draft-07/schema#&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;traits&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;E-Mail&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ory.sh/kratos&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;credentials&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;identifier&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;recovery&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;verification&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;full_name&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;title&#34;</span><span class="p">:</span><span class="s2">&#34;Full Name&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;phone_number&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;title&#34;</span><span class="p">:</span><span class="s2">&#34;Phone Number&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;format&#34;</span><span class="p">:</span> <span class="s2">&#34;tel&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;email&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;full_name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;phone_number&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;additionalProperties&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">identity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">default_schema_id</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">schemas</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">base64://above_file_in_base64</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We run <code>helmfile apply</code> to update kratos release, and then if we visit again the registration page we will notice the form get updated.</p>
<h3 id="add-oidcgithub">Add OIDC(Github)</h3>
<p>Sometimes you get lazy and don&rsquo;t want to type your email and use another random forgettable password, instead you choose to login with an your social accounts.</p>
<p>As an example let&rsquo;s add github signin feature, we will need a github oauth app with read:user and user:email scopes but creating this is outside of this tutorial scope, you can follow github documentation and return back with github oauth2 app credentials.</p>
<p>After you get the app, you added it under selfservice/methods/oidc/config/provider[0], here is an example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selfservice</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">methods</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">oidc</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">providers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">github</span><span class="w"> </span><span class="c"># this is `&lt;provider-id&gt;` in the Authorization callback URL. DO NOT CHANGE IT ONCE SET!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l">github</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="l">client_id</span><span class="w"> </span><span class="c"># Replace this with the Client ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">client_secret</span><span class="p">:</span><span class="w"> </span><span class="l">client_secret</span><span class="w"> </span><span class="c"># Replace this with the Client secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">issuer_url</span><span class="p">:</span><span class="w"> </span><span class="l">https://api.github.com </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mapper_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;base64://bG9jYWwgY2xhaW1zID0gc3RkLmV4dFZhcignY2xhaW1zJyk7Cgp7CiAgaWRlbnRpdHk6IHsKICAgIHRyYWl0czogewogICAgICBlbWFpbDogY2xhaW1zLmVtYWlsLAogICAgICB1c2VybmFtZTogY2xhaW1zLm5hbWUsCiAgICAgIHBob25lX251bWJlcjoxMjMKICAgIH0sCiAgfSwKfQ==&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">scope</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">read:user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">user:email</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">requested_claims</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">id_token</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">email</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">essential</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">full_name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">essential</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">phone_number</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">essential</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>the mapper_url is a jsonet file encoded base64, it extract the user information return by oidc and pass to kratos for creating identity</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">  local claims = std.extVar(&#39;claims&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">    identity: {
</span></span><span class="line"><span class="cl">      traits: {
</span></span><span class="line"><span class="cl">        email: claims.email,
</span></span><span class="line"><span class="cl">        full_name: claims.name
</span></span><span class="line"><span class="cl">      },
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>you may notice the phone_nubmer isn&rsquo;t passed from github, in that case kratos will return the user to registration to complete the missing field. and then we change kratos-ui to allow it to show the social-login button, here is the added code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">addIdentity</span><span class="p">(</span><span class="nx">identityId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">await</span> <span class="nx">sdk</span><span class="p">.</span><span class="nx">identity</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">getIdentity</span><span class="p">({</span> <span class="nx">id</span>: <span class="kt">identityId</span><span class="p">,</span> <span class="nx">includeCredential</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;oidc&#34;</span><span class="p">]</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(({</span> <span class="nx">data</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span> <span class="p">...</span><span class="nx">sdk</span><span class="p">,</span> <span class="nx">addIdentity</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>build the image and push it with a new tag: v2, then update the <strong>image value</strong> on kratos-ui chart and finally run <code>helmfile apply</code> to update the releases.</p>
<p>Voila, you can see now Login/Register with Github.</p>
<p><img loading="lazy" src="/img/kratos_login_github.png" alt="kratos_login_page_with_github_button"  />
</p>
<h2 id="hydra">Hydra</h2>
<h3 id="introduction-2">Introduction</h3>
<p>After identifying the user, he may need to access some of our protected resources, that&rsquo;s when he need to talk to an authorization server to give him token to access with it.</p>
<p>Hydra will act as an authorization server here. It generates, validates, and revokes tokens. Hydra and Kratos integrate well.</p>
<p>Like Kratos, Hydra contains 2 services: public and admin. Another interesting component is <a href="https://github.com/ory/hydra-maester">hydra Maester</a>. It is a Kubernetes controller that provides CRD for simplifying the creation of OAuth2 clients, but we will ignore it in this case as we will create clients manually with the Hydra CLI.</p>
<h3 id="deploying-1">Deploying</h3>
<p>We will copy the same methodalogy for deploying kratos,start by downloading hydra chart values and do a couple of modifications to enable ingress and integrate with kratos,..etc.</p>
<p>for ingress we will enable just the public service with following code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">public</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">hydra.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">ImplementationSpecific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">enkinineveh.space-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">hydra.enkinineveh.space</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>also hydra will need a database for storing it&rsquo;s own state, under hydra.config we will add dsn parameter and allow the the migration to create database and the related tables:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">hydra</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dsn</span><span class="p">:</span><span class="w"> </span><span class="l">postgres://hydra:hydra@cluster-pg-rw.cnpg-system:5432/hydra</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">automigration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Going forward to kratos integration part, there a property under config called &lsquo;urls&rsquo; where we will provide a set of links referencing the login, registration, logout, consent(for showing user scopes that he will accept on) and identity_provider is the url</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">urls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">self</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="l">https://hydra.enkinineveh.space/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">login</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/login</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">registration</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/registration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">consent</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/consent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">logout</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/logout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">identity_provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">https://kratos.enkinineveh.space/app</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>self.issuer</strong> is important here as the created token will contains an iss field in claims</p>
</blockquote>
<p>by default hydra will use opaque tokens, we will change that to JWT self defined tokens with following code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">access_token</span><span class="p">:</span><span class="w"> </span><span class="l">jwt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">jwt</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">scope_claim</span><span class="p">:</span><span class="w"> </span><span class="l">list</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>finally, we need create a secret key for encrypting user credentials, tokens,etc&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">system</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">YU03TmVqdzdjNUc4WVhtVTVtQ0RJb1FodXdhc1JsVW8=</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;are ready to deploy, we will update helmfile and run <code>helmfile apply</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hydra</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">ory/hydra</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">hydra/hydra-values.yaml</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Quick look at k9s, you will notice 3 pods two are active and the last one is terminated as it was initiazed by k8s job to run migration for db.
<img loading="lazy" src="/img/k9s_hydra.png" alt="k9s pods"  />
</p>
<h3 id="creating-oauth2-clients">Creating Oauth2 Clients</h3>
<p>Returning back to the project requirements, for the first use case, it enforces us into creating two different OAuth2 clients with a clean separation of concerns. That means, one for internal communication and the other one between the frontend and backend. In fact, each client must have minimal scopes and a targeted audience. For the second use case, we must create another client to handle connecting directly to the location service.</p>
<p>Creating clients with Hydra is a straightforward action. We can use the admin service or the Hydra CLI if you have it installed. I wanted to change the method a bit, so I went for installing the CLI and had some tinkering with it.</p>
<blockquote>
<p>because hydra-admin cannot be accessed outside of cluster, I will port-forward to localhost:4445</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  kpf -n auth services/hydra-admin 4445:4445 
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  hydra create oauth2-client --name frontend-backend-client --audience backend-service<span class="se">\ </span>--endpoint http://localhost:4445 --grant-type authorization_code,refresh_token <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --response-type code --redirect-uri http://localhost:8000/oauth-redirect --scope offline_access,openid --skip-consent <span class="nb">true</span> --skip-logout-consent <span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --token-endpoint-auth-method client_secret_post
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  hydra create oauth2-client  --name internal-communication --audience internal-service --endpoint http://localhost:4445 --grant-type client_credentials <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     --token-endpoint-auth-method client_secret_basic --scope offline_access,openid,location:read
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  hydra create oauth2-client --name third-party --audience backend-service<span class="se">\ </span>--endpoint http://localhost:4445 --grant-type authorization_code,refresh_token <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --response-type code --redirect-uri http://localhost:8000/oauth-redirect --scope offline_access,openid,location:read<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --token-endpoint-auth-method client_secret_post
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first client will settle between the frontend and backend. After the user registers, they don&rsquo;t need to approve a certain consent because they are dealing with their own data through our trusted app. Then an authorization code will be sent to the redirect URL in the frontend and it will be sent back to the backend for access and refresh token exchange.</p>
<p>The second client will handle the authorization internally, meaning machine-to-machine communication. It contains the location
scope to call the Location service.</p>
<p>The latter will be provided to third parties to get authorized for accessing user data.</p>
<p>Here is a demo of the current setup.</p>
<h2 id="oathkeeper">Oathkeeper</h2>
<h3 id="introduction-3">Introduction</h3>
<p>Token doesn&rsquo;t have a value if there is no validation entity, so from the project requirements, we need to enforce access to the location service to only JWTs with the &rsquo;location&rsquo;scope. That being said, there are two goals we need to achieve:</p>
<ul>
<li>Validate tokens when the service called internaly.</li>
<li>Validate tokens When location service become public and a third party needs an access to.</li>
</ul>
<p>Oathkeeper is a PEP (Policy Enforcement Point) composed of two services: proxy and API.</p>
<p>The proxy service can sit in front of the protected resource, intercepting requests and then deciding based on given rules if the request should be allowed or denied. In this project, we set the redirect ingress request to the Oathkeeper proxy and then Oathkeeper decides based on the rules if it should allow or deny.</p>
<h3 id="deploying-2">Deploying</h3>
<p>Let&rsquo;s use the same strategy we did with the previous services (Hydra, Kratos). Start by downloading the values.yaml file and make a couple of modifications to adjust for our needs.</p>
<p>We will keep services private and instead pass to Nginx a private domain: oathkeeper-proxy.</p>
<p>Oathkeeper has different handlers for authentication, authorization, mutation, and errors. To enable a specific handler, you need to define it under oathkeeper.config.</p>
<p>Our case requires adding authentication using JWT, authorization, logging errors as JSON, and regex for parsing rules.
So here is the added code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">access_rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matching_strategy</span><span class="p">:</span><span class="w"> </span><span class="l">regexp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">repositories</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">file:///etc/rules/access-rules.json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">authenticators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">jwt</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">jwks_urls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">https://hydra.enkinineveh.space/.well-known/jwks.json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">scope_strategy</span><span class="p">:</span><span class="w"> </span><span class="l">hierarchic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">jwks_max_wait</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">authorizers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">allow</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">errors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">json</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>finally update helmfile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">oathkeeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">ory/oathkeeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">oathkeeper/oathkeeper-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">kratos</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="rules">Rules</h3>
<p>For beginning, we will write our first rule to restrict access to the backend from the frontend side, updating oathkeeper.accessRules:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">oathkeeper</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessRules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;id&#34;: </span><span class="s2">&#34;backend-rule&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;upstream&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;url&#34;: </span><span class="s2">&#34;http://backend-app-charts.auth&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;match&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;url&#34;: </span><span class="s2">&#34;http://backend-test.enkinineveh.space/&lt;.*&gt;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;methods&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;GET&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;POST&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;OPTIONS&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;PUT&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;PATCH&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;authenticators&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;jwt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;authorizer&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;errors&#34;</span><span class="p">:[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s2">&#34;handler&#34;</span><span class="p">:</span><span class="s2">&#34;json&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and then update backend ingress to reference the oathkeeper API , here is how:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">backend-test.enkinineveh.space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">oathkeeper-proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">4455</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Here we told nginx to forward request to oathkeeper proxy. Now let&rsquo;s test the whole authentication, here is a quick demo</p>
<video width="640" height="360" controls>
  <source src="/videos/authorization_oathkeeper.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<h3 id="mutation">Mutation</h3>
<p>One handler I didn&rsquo;t mention before is mutation, the project requires we pass user_id as a header to the targeted service(backend,location) that&rsquo;s where mutation handler gonna work. Let&rsquo;s update the oathkeeper config</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Global configuration file oathkeeper.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mutators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">header</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Set enabled to true if the authenticator should be enabled and false to disable the authenticator. Defaults to false.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>then we change the rules on <strong>oathkeeper.accessRules</strong> and <strong>oathkeeper.config</strong> to add mutation</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JSON" data-lang="JSON"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;mutators&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;handler&#34;</span><span class="p">:</span> <span class="s2">&#34;header&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;headers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;USER_ID&#34;</span><span class="p">:</span> <span class="s2">&#34;{{ print .Subject }}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">oathkeeper</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mutators</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">header</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">headers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">USER_ID</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ print .Subject }}&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We can get token and request <strong>backend-test.enkinineveh.space/headers</strong> we will see <strong>USER_ID</strong> was passed</p>
<h2 id="istio-authorization">Istio Authorization</h2>
<p>One last requirement the project needs is for the backend to get an access_token with the &ldquo;location&rdquo; scope and then request the location service.</p>
<p>To force JWT authentication in the internal services, we need a service mesh. The location deployment needs to be placed inside a service mesh and tracked by a sidecar. We&rsquo;re going to choose Istio as a service mesh. The steps to integrate this feature are:</p>
<p>1- Add Oathkeeper Rule to handle location service access</p>
<p>2- Install the sidecar by labeling the deployment.</p>
<p>3- Use Istio meshconfig to configure an external authorizer.</p>
<p>4- Create an authorization policy to use the declared external authorizer and restrict deployment.</p>
<p>here is the access rule to force JWT with &ldquo;location:read&rdquo; scope to access location service</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">&#34;id&#34;: </span><span class="s2">&#34;location-rule&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">&#34;match&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;url&#34;: </span><span class="s2">&#34;http://location-app-charts.auth/&lt;.*&gt;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;methods&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s2">&#34;GET&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s2">&#34;POST&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s2">&#34;OPTIONS&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s2">&#34;PUT&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s2">&#34;PATCH&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s2">&#34;HEAD&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">&#34;authenticators&#34;: </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;jwt&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">&#34;config&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;scope_strategy&#34;: </span><span class="s2">&#34;hierarchic&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;required_scope&#34;: </span><span class="p">[</span><span class="s2">&#34;location:read&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">&#34;authorizer&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;allow&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">&#34;mutators&#34;: </span><span class="p">[</span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;handler&#34;: </span><span class="s2">&#34;header&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;config&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;headers&#34;: </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">&#34;USER_ID&#34;: </span><span class="s2">&#34;{{ print .Subject }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="p">],</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;errors&#34;</span><span class="p">:[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>{<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="s2">&#34;handler&#34;</span><span class="p">:</span><span class="s2">&#34;json&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>I will not show you how to install Istio because this is outside the article&rsquo;s scope, but you can follow their documentation; it is easy and comprehensive.</p>
<p>After you install Istio, to add the Istio sidecar alongside the &rsquo;location deployment&rsquo;, we edit the podLabels on the location chart:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podLabels</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Next, let&rsquo;s declare the Istio external authorizer, which will call the /decisions endpoint on the Oathkeeper API to decide if requests are allowed or denied. For example, suppose the backend wants to call the Location service with the URL: <a href="http://location.auth/user_location">http://location.auth/user_location</a>. Then the Istio sidecar will intercept this request and forward it to the Oathkeeper API with the path &ldquo;/decisions/user_location&rdquo; and the host header &ldquo;location.auth&rdquo;. So let&rsquo;s edit the Istio ConfigMap and add the Oathkeeper external provider:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">extensionProviders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ext-authz&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">envoyExtAuthzhHttp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;oathkeepr-api.auth.svc.cluster.local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">4456</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">failOpen</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">statusOnError</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;500&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pathPrefix</span><span class="p">:</span><span class="w"> </span><span class="l">/decisions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">includeRequestHeadersInCheck</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;authoirzation&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, create an AuthorizationPolicy to use the declared external authorizer and restrict deployment:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">security.istio.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AuthorizationPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">location-oathkeeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">location-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">CUSTOM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ext-authz</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>With these steps, the Istio sidecar will intercept requests to the location service and validate them using Oathkeeper, ensuring that only requests with valid JWT tokens and the correct scopes are allowed.</p>
<video width="640" height="360" controls>
  <source src="/videos/authorization_location_oathkeeper.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<h2 id="third-party-client">Third Party Client</h2>
<p>If we need to put location service public and let third parties access it, the steps to achieve this are:</p>
<ul>
<li>delete Authorization Policy</li>
<li>enable ingress on service</li>
<li>change access rule match.url to ingress host</li>
</ul>
<p>and that&rsquo;s all, you can create a client and handle it to a third party to access your service directly</p>
<h2 id="conclusion">Conclusion</h2>
<p>I appreciate your time for reading this.</p>
<h2 id="references">References</h2>
<p><a href="https://github.com/hamzabouissi/k8s_authorization_with_ory">github_project</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>Oops...Etcd went down</title>
      <link>//localhost:1313/posts/etcd_went_down/</link>
      <pubDate>Thu, 30 May 2024 11:12:57 +0100</pubDate>
      <guid>//localhost:1313/posts/etcd_went_down/</guid>
      <description>Introduction with 1-Mistake On that shiny day, I got a project that required deploying a mongodb cluster, After a few searches, I found percona Operator, moved into installation section and copied the helm install command.
After installing the required charts, I noticed that the pods weren&amp;rsquo;t in &amp;ldquo;running&amp;rdquo; state, so as a civilized kubernetes developer I ran &amp;ldquo;kubectl describe pod_name -n namespace&amp;rdquo;, and it turned out the problem was mongodb cluster requires either 3 or 5 nodes</description>
      <content:encoded><![CDATA[<h2 id="introduction-with-1-mistake">Introduction with 1-Mistake</h2>
<p>On that shiny day, I got a project that required deploying a mongodb cluster,
After a few searches, I found percona Operator, moved into installation section and copied the helm install command.</p>
<p>After installing the required charts, I noticed that the pods weren&rsquo;t in &ldquo;running&rdquo; state, so as a civilized kubernetes developer I ran &ldquo;kubectl describe pod_name -n namespace&rdquo;, and it turned out the problem was mongodb cluster requires either 3 or 5 nodes</p>
<p>That&rsquo;s easy right ? !&lsquo;am using proxmox for my on-prem VMs and talos for my kubernetes OS, therefore I created a new VM with talos as The OS, disabled DHCP and added custom IP address corresponding to 192.168.1.116. Then, to add the VM a new <strong>&ldquo;worker&rdquo;</strong> node we use Talos magic wand:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">talosctl apply-config --insecure --nodes 192.168.1.116 --file worker.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>But life always hides a few surprises for you , I mistakenly ran another command which added the new VM as a controller plane.
The result was <strong>having two etcd members</strong> fighting for their survivals, but our old master &ldquo;kubernetes&rdquo; wasn&rsquo;t happy with the result because both etcd instance went down with their kube-apiserver instances</p>
<h2 id="2-mistake">2-Mistake</h2>
<p>Because I am so smart, I thought the two controller nodes contradicted with etcd&rsquo;s happy state, so I searched for a solution that led me into either removing the newly created node or adding a new one to balance the cluster number, And hell yeah, Iam removing the second idiot VM.</p>
<p>The node deleted from <strong>&ldquo;proxmox&rdquo;</strong>,then I thought the cluster will return to healthy state and I will kiss my &ldquo;IT&rdquo; girlfriend saying &ldquo;we&rsquo;re back to normal&rdquo; making her think I was mad at her for no reason, hmm but life surprises you once again, my dear.</p>
<p>This time, etcd remained in an unhealthy state, claiming it couldn&rsquo;t find the joined node 192.168.1.116</p>
<blockquote>
<p><strong><em>NOTE:</em></strong> you can run &rsquo;talosctl -n 192.168.1.110 dmesg&rsquo; to view node logs .</p>
</blockquote>
<p>I thought, I saw a talosctl command that invokes a members list and I said to myself if the &ldquo;list&rdquo; subcommand exists, then the remove or delete one will exist also, Well it was there of course, but with a different name: &ldquo;remove-member&rdquo;. however, it didn&rsquo;t work, etcd wasn&rsquo;t responding to my requests even the command : &ldquo;talosctl members list&rdquo; wasn&rsquo;t showing anything.</p>
<h2 id="solution-edit-the-etcd-snapshotted-db">Solution: Edit the Etcd Snapshotted DB</h2>
<p>After long hours of reading Github issues, walking on the beach and talking with friends about rap songs I realized there was no solution other than to reset the controller node along with the etcd data directory.</p>
<p>While reading the documentation on Talos &ldquo;Disator Recovery&rdquo;, I was made aware of the snapshot idea but wasn&rsquo;t thinking outside the box.
Until I thought of editing the etcd database, talosctl didn&rsquo;t have a built-in command for this kind of operation so I went for snapshotting the database and inspecting it to see what I can edit there to remove the call for the our beloved dead node.</p>
<p>Let&rsquo;s start with taking a snapshot, there are two commands referenced in the documentation but we will go with latter because etcd is unreachable</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">talosctl -n 192.168.1.110 cp /var/lib/etcd/member/snap/db .
</span></span></code></pre></td></tr></table>
</div>
</div><p>I ran the &lsquo;file&rsquo; command to check file type which returned: <strong>data</strong>, hmm well this isn&rsquo;t enough linux, thanks for your time, On my second search on google I found the <strong>bbolt file type</strong> and there is this tool <strong>bbolt</strong> for inspecting bbolt databases, Cool now we playing our cards right.</p>
<p>After a few tries, I found a bucket called &ldquo;members&rdquo;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bbolt buckets db
</span></span><span class="line"><span class="cl">    alarm
</span></span><span class="line"><span class="cl">    auth
</span></span><span class="line"><span class="cl">    authRoles
</span></span><span class="line"><span class="cl">    authUsers
</span></span><span class="line"><span class="cl">    cluster
</span></span><span class="line"><span class="cl">    key
</span></span><span class="line"><span class="cl">    lease
</span></span><span class="line"><span class="cl">    members &lt;- this one
</span></span><span class="line"><span class="cl">    members_removed
</span></span><span class="line"><span class="cl">    meta
</span></span></code></pre></td></tr></table>
</div>
</div><p>hmm, I procceded into list members bucket keys and inspecting each value</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bbolt keys db members
</span></span><span class="line"><span class="cl">    3cf1b5e76f18a513
</span></span><span class="line"><span class="cl">    920c1b791dddb17e
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bbolt get db members 3cf1b5e76f18a513
</span></span><span class="line"><span class="cl">    <span class="o">{</span><span class="s2">&#34;id&#34;</span>:4391491117268903187,<span class="s2">&#34;peerURLs&#34;</span>:<span class="o">[</span><span class="s2">&#34;https://192.168.1.110:2380&#34;</span><span class="o">]</span>,<span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;talos-zrr-lqe&#34;</span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bbolt get db members 920c1b791dddb17e
</span></span><span class="line"><span class="cl">    <span class="o">{</span><span class="s2">&#34;id&#34;</span>:10523816636264067454,<span class="s2">&#34;peerURLs&#34;</span>:<span class="o">[</span><span class="s2">&#34;https://192.168.1.116:2380&#34;</span><span class="o">]</span>,<span class="s2">&#34;isLearner&#34;</span>:true<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>here we go Kogoro Mouri, I found the culprit this member with key 920c1b791dddb17e must be deleted, so let&rsquo;s call the POLICE(ChatGPT) to exceel him out.
We asked ChatGPT for deleting the key <strong>920c1b791dddb17e</strong> from members buckets</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;go.etcd.io/bbolt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Open the BoltDB database file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bbolt</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;db&#34;</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The key we want to delete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">key</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;920c1b791dddb17e&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Update the database to delete the key from the &#34;members&#34; bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">bbolt</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Get the bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;members&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">bucket</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">bbolt</span><span class="p">.</span><span class="nx">ErrBucketNotFound</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Delete the key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Could not delete key: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Key deleted successfully&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we can reset the etcd node and then recover from the backup db</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">talosctl -n 192.168.1.110 reset --graceful<span class="o">=</span><span class="nb">false</span> --reboot --system-labels-to-wipe<span class="o">=</span>EPHEMERAL
</span></span></code></pre></td></tr></table>
</div>
</div><p>wait until the node become in preparing mode and run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">talosctl -n &lt;IP&gt; bootstrap --recover-from<span class="o">=</span>./db.snapshot --recover-skip-hash-check
</span></span></code></pre></td></tr></table>
</div>
</div><p>finally run, &lsquo;kubectl get nodes -o wide&rsquo; and you should see your nodes</p>
<p>&lsquo;kubectl get pods&rsquo; to check your cluster previous state returned to normal</p>
]]></content:encoded>
    </item>
    <item>
      <title>Deploying gitea into kubernetes with custom domain</title>
      <link>//localhost:1313/posts/deploy-gitea-k8s/</link>
      <pubDate>Sat, 20 May 2023 16:12:38 +0100</pubDate>
      <guid>//localhost:1313/posts/deploy-gitea-k8s/</guid>
      <description>Introduction Hello, lately I have been trying to deploy a custom Docker image into my local Kubernetes cluster. It turned out I needed to host my Docker image on a container registry, either Docker Hub, which is not suitable for my use case, or deploy and use a local registry. During my research, I found Gitea, which I liked as it allows me to deploy all my projects on it and also host the containers.</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Hello, lately I have been trying to deploy a custom Docker image into my local Kubernetes cluster. It turned out I needed to host my Docker image on a container registry, either Docker Hub, which is not suitable for my use case, or deploy and use a local registry. During my research, I found Gitea, which I liked as it allows me to deploy all my projects on it and also host the containers.</p>
<h2 id="prerequisite">Prerequisite</h2>
<pre><code>* kubernetes cluster
* external server(S3,NFS) for dynamic provisioning
* metallb installed
</code></pre>
<h2 id="create-pvc-for-nfs-server">Create PVC for NFS Server</h2>
<p>With the help of Proxmox, I created a VM and configured it as an NFS server on 192.168.1.109. To use this server in our Kubernetes cluster, we need to create a StorageClass and then create a PVC that points to that class so pods can use it.</p>
<p><img loading="lazy" src="/img/pvc.png" alt="pvc"  />
</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --create-namespace <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace nfs-provisioner <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set nfs.server<span class="o">=</span>192.168.1.109 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set nfs.path<span class="o">=</span>/srv/public/nfs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we create a PVC, linking it to the storageClassName:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage.k8s.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage.k8s.io/part-of</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-complete-reference</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">15Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>If we want the deployment to store its volume in NFS, we define volumes with the argument persistentVolumeClaim = nfs-test. Here is an example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">task-pv-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">task-pv-storage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="deploy-gitea--postgresql--redis">Deploy Gitea + PostgreSQL + Redis</h2>
<p>To facilitate deploying resources into Kubernetes, we use Helm. With one command and changing a few values, we can deploy our resources. Before deploying, when I was reading the Gitea chart, I noticed Gitea requires PostgreSQL and Redis to be deployed alongside it to save its configs and states.</p>
<p>So let&rsquo;s create a file &lsquo;values-gitea.yaml&rsquo; and add the default chart values.</p>
<p>Then change the following values:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">postgresql-ha</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">postgresql</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>I disabled the deployment of Postgres-HA because I didn&rsquo;t need it for my use case. However, if you&rsquo;re deploying for your organization where multiple users are pushing and pulling, you may keep it enabled.</p>
<p>Now to deploy the Helm release with the modifications, run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  helm install gitea gitea-charts/gitea --values values-gitea.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong><em>NOTE:</em></strong> You need a cluster with an internet connection to pull the Docker images.</p>
</blockquote>
<blockquote>
<p><strong><em>NOTE:</em></strong> If you don&rsquo;t specify the namespace, it will choose the &lsquo;default&rsquo; namespace.</p>
</blockquote>
<p>Now, we wait until the images get pulled and deployed. You can watch the pods by running:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  kubectl get pods -w
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/img/k9s_screenshoot.png" alt="k9s pods"  />
</p>
<p>After all the pods are deployed, to access Gitea, we need to either open a port or create an ingress. Let&rsquo;s try the port-forwarding mechanism for now to test the app:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl port-forward service/gitea-http 3000:3000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now go to <a href="http://localhost:3000">http://localhost:3000</a> and test, you can login as gitea_admin, password: r8sA8CPHD9!bt6d</p>
<p>To access Gitea from another pod, CoreDNS provides a default resolving mechanism in the form: service_name.namespace.svc.cluster.local. In our example, the DNS for Gitea is: gitea-http.default.</p>
<h2 id="deploy-controller-nginx">Deploy Controller Nginx</h2>
<p>For testing purposes, port-forwarding may be a good solution, but if we want a more reliable solution and even attach a domain with HTTPS to the Gitea service, we need an ingress.</p>
<p>To start with ingress, an ingress controller is needed. We will choose the most popular one: nginx-ingress.</p>
<p>following this <a href="https://docs.nginx.com/nginx-ingress-controller/installation/installing-nic/installation-with-helm/">article</a>, choosing helm install, I got the below command to run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  helm install my-release oci://ghcr.io/nginxinc/charts/nginx-ingress --version 1.2.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>If everything works as expected, you should see an ingress-controller service with an IP address from your load-balancer (MetalLB) pool of IP addresses.</p>
<p><img loading="lazy" src="/img/nginx_controller.png" alt="nginx-ingress service"  />
</p>
<p>Great, to expose Gitea, we will change the previous chart file &lsquo;values-gitea.yaml&rsquo; values:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">gitea.homelab.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>here we instructed to create an ingress rule:</p>
<pre><code>- className is needed if you have multiple ingress controllers installed
- the host part tell ingress to accept any request with domain or  host header : gitea.homelab.local and forward it to gitea instance  
</code></pre>
<p>To redeploy the release with the new configuration, we run:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm upgrade gitea gitea-charts/gitea --values values-gitea.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we check the ingresses, we can find Gitea ingress has been created. To test it, we will query the IP address of the ingress, supplying a custom host header: gitea.homelab.local.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl --header <span class="s1">&#39;Host: gitea.homelab.local&#39;</span> ingress_ip_address
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="deploy-bind9">Deploy bind9</h2>
<p>You may notice that accessing Gitea from a browser isn&rsquo;t possible because the local DNS server doesn&rsquo;t have knowledge of the domain: homelab.local. The solution is either to modify the /etc/hosts file or create a CT in Proxmox and host a DNS server there.</p>
<p>I went for the second option, hosting a DNS server because my homelab may require a variety of services in the future, and I want them to be mapped to a domain for all the connected devices in my network.</p>
<p>For the DNS server, Pi-hole may be the most popular option for ad-blocking and adding DNS records, but I experienced a few bugs with serving DNS, so I went with the second option: Bind9.</p>
<p>I read this <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-private-network-dns-server-on-ubuntu-20-04#step-2-configuring-the-primary-dns-server">article</a></p>
<p>I created a CT in proxmox and assigned a static ip 192.168.1.114, don&rsquo;t use dhcp because it may change if CT restarted. So here are my configuration</p>
<p><strong>my local ip address</strong>: 192.168.1.104, <strong>ingress ip address</strong>: 192.168.1.148</p>
<p>filename: /etc/bind/named.conf.options</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">acl &#34;trusted&#34; {
</span></span><span class="line"><span class="cl">  192.168.1.0/24;
</span></span><span class="line"><span class="cl">};
</span></span><span class="line"><span class="cl">options {
</span></span><span class="line"><span class="cl">  directory &#34;/var/cache/bind&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // If there is a firewall between you and nameservers you want
</span></span><span class="line"><span class="cl">  // to talk to, you may need to fix the firewall to allow multiple
</span></span><span class="line"><span class="cl">  // ports to talk.  See http://www.kb.cert.org/vuls/id/800113
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // If your ISP provided one or more IP addresses for stable
</span></span><span class="line"><span class="cl">  // nameservers, you probably want to use them as forwarders.
</span></span><span class="line"><span class="cl">  // Uncomment the following block, and insert the addresses replacing
</span></span><span class="line"><span class="cl">  // the all-0&#39;s placeholder.
</span></span><span class="line"><span class="cl">  recursion yes;
</span></span><span class="line"><span class="cl">  allow-recursion { trusted; };
</span></span><span class="line"><span class="cl">  listen-on { 192.168.1.114;};
</span></span><span class="line"><span class="cl">  allow-transfer { none; };
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // forwarders {
</span></span><span class="line"><span class="cl">  //      0.0.0.0;
</span></span><span class="line"><span class="cl">  // };
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  //========================================================================
</span></span><span class="line"><span class="cl">  // If BIND logs error messages about the root key being expired,
</span></span><span class="line"><span class="cl">  // you will need to update your keys.  See https://www.isc.org/bind-keys
</span></span><span class="line"><span class="cl">  //========================================================================
</span></span><span class="line"><span class="cl">  dnssec-validation auto;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  listen-on-v6 { any; };
</span></span><span class="line"><span class="cl">};
</span></span></code></pre></td></tr></table>
</div>
</div><p>filename: /etc/bind/named.conf.local</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">zone &#34;homelab.local&#34; {
</span></span><span class="line"><span class="cl">    type master;
</span></span><span class="line"><span class="cl">    file &#34;/etc/bind/zones/db.homelab.local&#34;;
</span></span><span class="line"><span class="cl">};
</span></span><span class="line"><span class="cl">zone &#34;168.192.in-addr.arpa&#34; {
</span></span><span class="line"><span class="cl">    type primary;
</span></span><span class="line"><span class="cl">    file &#34;/etc/bind/zones/db.192.168&#34;;  # 192.168.0.0/24 subnet
</span></span><span class="line"><span class="cl">};
</span></span></code></pre></td></tr></table>
</div>
</div><p>filename: zones/db.homelab.local</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">;
</span></span><span class="line"><span class="cl">; BIND data file for local loopback interface
</span></span><span class="line"><span class="cl">;
</span></span><span class="line"><span class="cl">$TTL    604800
</span></span><span class="line"><span class="cl">@       IN      SOA     homelab.local. admin.homelab.local. (
</span></span><span class="line"><span class="cl">                              3         ; Serial
</span></span><span class="line"><span class="cl">                         604800         ; Refresh
</span></span><span class="line"><span class="cl">                          86400         ; Retry
</span></span><span class="line"><span class="cl">                        2419200         ; Expire
</span></span><span class="line"><span class="cl">                         604800 )       ; Negative Cache TTL
</span></span><span class="line"><span class="cl">;
</span></span><span class="line"><span class="cl">; name servers - NS records
</span></span><span class="line"><span class="cl">    IN      NS      ns1.homelab.local.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; name servers - A records
</span></span><span class="line"><span class="cl">ns1.homelab.local.            IN      A       192.168.1.114
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; name servers - A records
</span></span><span class="line"><span class="cl">gitea.homelab.local.          IN      A       192.168.1.148
</span></span></code></pre></td></tr></table>
</div>
</div><p>filename: /etc/bind/zones/db.168.192</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">;
</span></span><span class="line"><span class="cl">; BIND reverse data file for local loopback interface
</span></span><span class="line"><span class="cl">;
</span></span><span class="line"><span class="cl">$TTL    604800
</span></span><span class="line"><span class="cl">@       IN      SOA     ns1.homelab.local. admin.homelab.local. (
</span></span><span class="line"><span class="cl">                              3         ; Serial
</span></span><span class="line"><span class="cl">                         604800         ; Refresh
</span></span><span class="line"><span class="cl">                          86400         ; Retry
</span></span><span class="line"><span class="cl">                        2419200         ; Expire
</span></span><span class="line"><span class="cl">                         604800 )       ; Negative Cache TTL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; name servers - NS records
</span></span><span class="line"><span class="cl">      IN      NS      ns1.homelab.local.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">; PTR Records
</span></span><span class="line"><span class="cl">114.1   IN      PTR     ns1.homelab.local.    ; 192.168.1.114
</span></span><span class="line"><span class="cl">148.1   IN      PTR     gitea.homelab.local.  ; 192.168.1.148
</span></span></code></pre></td></tr></table>
</div>
</div><p>once the the bind9 configured and it&rsquo;s working, we need to add the dns server ip address as an additional one, am using NetworkManager:</p>
<p><img loading="lazy" src="/img/network_manager_dns.png" alt="network_manager"  />
</p>
<h2 id="add-tls">Add TLS</h2>
<p>Now, if we try to login into to the Gitea registry using the below command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker login gitea.homelab.local
</span></span></code></pre></td></tr></table>
</div>
</div><p>It will return an error claiming the registry domain needs a TLS certificate. We can work around that by adding the registry domain to /etc/docker/daemon.json, but it would be more useful if we create a TLS certificate and append it to the domain.</p>
<p>We will start first by creating the cert. I chose mkcert because my first search led to it 😄.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkcert gitea.homelab.local
</span></span></code></pre></td></tr></table>
</div>
</div><p>It will generate two PEM files: a public key and a private key.</p>
<p>We will create a TLS secret and append the two created files from mkcert:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret tls gitea-secret <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --key gitea.homelab.local-key.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --cert gitea.homelab.local.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, we append the gitea-secret into the ingress by changing the gitea-values.yaml file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">gitea-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span>- <span class="l">gitea.homelab.local</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we can visit gitea.homelab.local and login to gitea registry without issues.</p>
<p><img loading="lazy" src="/img/docker_login.png" alt="docker-login"  />
</p>
<h2 id="change-nginx-config-for-pushing-the-image">Change nginx config for pushing the image</h2>
<p>We deployed Gitea with one main purpose in mind: pushing containers to the registry. However, if we try building a local image and pushing it, you may face an error saying: &ldquo;413 Request Entity Too Large&rdquo;!</p>
<p><img loading="lazy" src="/img/docker_push_413.png" alt="413_push_image"  />
</p>
<p>This is because by default Nginx imposes a limit of 1MB for uploading media files. To change that, we add an annotation for ingress to remove the limit:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.org/client-max-body-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>then we update the release chart</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm upgrade gitea gitea-charts/gitea --values values-gitea.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we can push the image: gitlab.homelab.local/gitea_admin/app:latest</p>
<p><img loading="lazy" src="/img/pushed_image.png" alt="pushed_image"  />
</p>
<p>if you have created another user instead of gitea_admin, you can replace it in the above command.</p>
<h2 id="add-bind9-server-in-coredns">Add Bind9 Server in CoreDNS</h2>
<p>We have done everything from deploying to adding TLS cert, but if we tried to create a deployment with the deployed image as an example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gitea.homelab.local/gitea_admin/app:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>after applying the yaml, if you run kubectl describe deployment/app_name
you may notice in the events section that it&rsquo;s stating pulling the image has failed, that&rsquo;s logical because kubernetes cluster doesn&rsquo;t know about our custom domain: <strong>homelab.local</strong>.</p>
<p>So to let kubernetes DNS server: CoreDNS, acknowledge our domain we gonna need a litle tweak into the CoreDNS config</p>
<p>we run the following command to open the editor with configmap:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl edit configmap -n kube-system coredns
</span></span></code></pre></td></tr></table>
</div>
</div><p>and then we add the reference to homelab.local</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">coredns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Corefile</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    .:53 {
</span></span></span><span class="line"><span class="cl"><span class="sd">        errors
</span></span></span><span class="line"><span class="cl"><span class="sd">        health
</span></span></span><span class="line"><span class="cl"><span class="sd">        kubernetes cluster.local in-addr.arpa ip6.arpa {
</span></span></span><span class="line"><span class="cl"><span class="sd">           pods insecure
</span></span></span><span class="line"><span class="cl"><span class="sd">           fallthrough in-addr.arpa ip6.arpa
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">        prometheus :9153
</span></span></span><span class="line"><span class="cl"><span class="sd">        forward . 172.16.0.1
</span></span></span><span class="line"><span class="cl"><span class="sd">        cache 30
</span></span></span><span class="line"><span class="cl"><span class="sd">        loop
</span></span></span><span class="line"><span class="cl"><span class="sd">        reload
</span></span></span><span class="line"><span class="cl"><span class="sd">        loadbalance
</span></span></span><span class="line"><span class="cl"><span class="sd">    }
</span></span></span><span class="line"><span class="cl"><span class="sd">    homalb.local:53 {
</span></span></span><span class="line"><span class="cl"><span class="sd">        errors
</span></span></span><span class="line"><span class="cl"><span class="sd">        cache 30
</span></span></span><span class="line"><span class="cl"><span class="sd">        forward . 192.168.1.114
</span></span></span><span class="line"><span class="cl"><span class="sd">    }  </span><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>and for the CoreDNS to take effect, we will restart it with :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl rollout restart -n kube-system deployment/coredns
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, to test things out you can redeploy the previous deployed yaml or just run an alpine with nslookup</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl run --image<span class="o">=</span>alpine:3.5 -it alpine-shell-1 -- nslookup gitea.homelab.local
</span></span></code></pre></td></tr></table>
</div>
</div><p>it should return the ip address of the ingress.</p>
]]></content:encoded>
    </item>
    <item>
      <title>GCP -&gt; AWS Migration: Hide Your Secrets</title>
      <link>//localhost:1313/posts/hide-your-secrets/</link>
      <pubDate>Fri, 19 May 2023 16:14:49 +0100</pubDate>
      <guid>//localhost:1313/posts/hide-your-secrets/</guid>
      <description>HIDING</description>
      <content:encoded><![CDATA[<p>HIDING</p>
]]></content:encoded>
    </item>
    <item>
      <title>GCP -&gt; AWS Migration: Confession</title>
      <link>//localhost:1313/posts/confession/</link>
      <pubDate>Tue, 25 Apr 2023 16:12:38 +0100</pubDate>
      <guid>//localhost:1313/posts/confession/</guid>
      <description>(Knock on the door)
(door opens)(some background noise of the company like people shatter or talk)
Yeah, Come In
Hey
Hey
Hey, my Junior friend, have a seat.
Thanks
It&amp;rsquo;s been 2 weeks since I assigned you the project, how it&amp;rsquo;s going?
Good, I&amp;rsquo;m doing good, I just finished a few tasks and as you asked about my progress.
So, can you tell me how much progress you have made?</description>
      <content:encoded><![CDATA[<p>(Knock on the door)</p>
<p>(door opens)(some background noise of the company like people shatter or talk)</p>
<p>Yeah, Come In</p>
<p>Hey</p>
<p>Hey</p>
<p>Hey, my Junior friend, have a seat.</p>
<p>Thanks</p>
<p>It&rsquo;s been 2 weeks since I assigned you the project, how it&rsquo;s going?</p>
<p>Good, I&rsquo;m doing good, I just finished a few tasks and as you asked about my progress.</p>
<p>So, can you tell me how much progress you have made?</p>
<p>I think am nearly 40%, I somehow finished creating the dev environment, so I can test with developers the performance and durability of the infrastructure.</p>
<p>What about PostgreSQL, Redis, Configuration and Secrets Management? And I saw your email about using AWS AURORA, did you figure out the answer ?</p>
<p>I deployed the database as an RDS, well I didn&rsquo;t find a real benefit in using Aurora for the dev environment, and also it is somehow expensive, but maybe we can use it on the prod environment as it offers scalability. For Redis, AWS has a fully managed service called Elastic Cache with integrated monitoring service CloudWatch and the last one Configuration Management I read about the service (AWS Secret Manager) that I will use but didn&rsquo;t integrate yet.</p>
<p>That seems fair, have you faced some challenges learning AWS, I heard from my fellow developers that there are a few steeping curves in understanding the documentation and the services.</p>
<p>Somehow yes, as I don&rsquo;t know that much about AWS and the time isn&rsquo;t enough for learning and practising, I choose a tool to be abstract for me the underlying infrastructure for now, but I am willing to learn what happens in the background, so I can customize more.</p>
<p>What&rsquo;s the tool name?</p>
<p>AWS Copilot (the CTO typing the name, we need to hear the keyboard typing) it&rsquo;s an open source project &hellip;.(the CTO interrupt saying)</p>
<p>Hmm, I see, but wouldn&rsquo;t that add a new layer to learn, because most DevOps developers on the market will stick with IAC?</p>
<p>Yeah, I thought of that, I noticed that copilot works upon CloudFormation, which is an IAC tool for AWS and if you&rsquo;re asking why not use Terraform with built-in modules, I can tell with this method we will narrow in the future our range of search to DevOps with terraform knowledge as with the current situation we can teach our backend developers a few commands and that&rsquo;s enough to monitor the infrastructure.</p>
<p>Interesting, I&rsquo;m the type of technical guy, can you explain more about the solution?</p>
<p>Ok, can I open my laptop to show you</p>
<p>(developer unpacking the laptop sound)</p>
<p>Yeah, Sure</p>
<p>have you thought of opening a startup (the CTO also) (CTO show some interest in the developer)</p>
<p>(think few seconds) No, I don&rsquo;t think I am ready, but maybe a small side hustle</p>
<p>Okay, let me log into my AWS account (while typing)(the developer said) add the MFA code and here we go.</p>
<p>(the sound of the CTO moving to the chair next to the developer)</p>
<p>So, here is the CloudFormation dashboard, those are the stacks that copilot deployed, you can also identify them by tags, generally they have tags copilotenvironment and copilot-application, at the end if somehow copilot didn&rsquo;t meet our expectation or we couldn&rsquo;t customize it further we can just modify, extend and boom. Now let me show the commands to set up and deploy the services&hellip;..</p>
<p>You didn&rsquo;t deploy the app Yet, right? (while interrupting)</p>
<p>Not Yet</p>
<p>Ok (with notification sound on the phone), Continue</p>
<p>To set up infrastructure first, we need to run <code>copilot app init</code> then <code>copilot env init</code> after that copilot will ask us a few questions about the public and private subnets and the availability zone of the load balancer after we confirm that we see 3 Cloudformation stack has been created which define a few resources(VPC, Subnets, RouteTables,InternetGateway, and Cluster for Containers), finally I will be writing all the steps on notion.</p>
<p>And the dependencies? (CTO asked)</p>
<p>Yeah, I did my search on deploy RDS and ElasticCache, Copilot doesn&rsquo;t support either of them as a built-in command, but we can extend and create the services by ourselves and this is what I have done, the extended functionality support CloudFormation&rsquo;s files</p>
<p>Got It, but, hmm(take a few seconds to rephrase ), but I&rsquo;m worrying if we don&rsquo;t understand carefully and let copilot create the infrastructure, it may lead to creating unuseful services and you know we&rsquo;re short on money.</p>
<p>Yeah, I understand your concern but am willing to learn more about the architecture copilot created for us by that time I can see if copilot fits our needs else I remove it and advance my skills to manage by myself the rest of the infrastructure directly with cloud formation</p>
<p>That seems fair enough, Ok, here is what you gonna do in the next few days. After you finish deploying that config management thing, deploy the application on ECS, and handle it to the developers to try and check the performance, and what about the CI/CD</p>
<p>Copilot support it but didn&rsquo;t take a deep look into the documentation, I can deploy the application from my terminal, so let&rsquo;s tell the project manager whenever there is a pull request merged they notify me so I pull the code and push it for review</p>
<p>Noted, I will tell him</p>
]]></content:encoded>
    </item>
    <item>
      <title>GCP -&gt; AWS Migration: Stress Swallows You</title>
      <link>//localhost:1313/posts/stress-swallows-you/</link>
      <pubDate>Thu, 20 Apr 2023 15:36:32 +0100</pubDate>
      <guid>//localhost:1313/posts/stress-swallows-you/</guid>
      <description>3 days passes, and I&amp;rsquo;m struggling on the same bug, Am I looking at the wrong side of the window, I don&amp;rsquo;t know, I think the best way to understand is going back and examine every command line and line of code I wrote.
So at first, After I took the decision to use AWS copilot, I look at the task on JIRA, analyzed it carefully and saw the need to deploy application dependencies first, one of the dependencies is the database .</description>
      <content:encoded><![CDATA[<blockquote>
<p><em>3 days passes, and I&rsquo;m struggling on the same bug, Am I looking at the wrong side of the window, I don&rsquo;t know, I think the best way to understand is going back and examine every command line and line of code I wrote.</em></p>
</blockquote>
<p>So at first, After I took the decision to use AWS copilot, I look at the task on JIRA, analyzed it carefully and saw the need to deploy application dependencies first, one of the dependencies is the database <strong>.</strong> We have been using PostgresSQL V14, so we just need the same version on the dev environment.</p>
<p>I run through the documentation, to catch any command on how to deploy a database with underlying infrastructure(VPC, Subnet, Route Table, &hellip;). The first command I saw</p>
<pre><code>copilot init
</code></pre>
<p>It fulfils the need of creating the underlying infrastructure, but it requires an application ready to deploy, but this is not the case now. A few minutes after and stumbled upon another command with the description &ldquo;creates a new <a href="https://aws.github.io/copilot-cli/docs/concepts/environments/">environment</a> where your services will live.&rdquo;</p>
<pre><code>copilot env init
</code></pre>
<p>When I run the above command, it asked me to run <code>copilot app init</code> first. And here is the output of environment creation</p>
<!-- raw HTML omitted -->
<p>From my understanding of the output and manifest.yml file, it seems after running <code>copilot env deploy</code> it will create two public and private subnets on separate regions. So I proceeded with the command, and here is the output</p>
<!-- raw HTML omitted -->
<p>I googled a few terms I didn&rsquo;t understand like ECS, security groups, and DNS namespace to have basic knowledge of what happens in the background.</p>
<p>The following task was deploying the database and this is when things got trickier, now one of the features of copilot is a command to deploy storage services like database, file system&hellip; etc. It supports two types of databases DynamoDB, Aurora</p>
<p>Aurora seems a great option as it&rsquo;s fully compatible with PostgresSQL, so I tried to deploy a cluster using the following command</p>
<pre><code> copilot storage init -n cluster -t Aurora --lifecycle environment --engine PostgreSQL
</code></pre>
<p>At the same time, I opened Thunderbird and I messaged the CTO asking if it was ok deploying Aurora instead of an RDS. I went back to the command and I found</p>
<blockquote>
<p>Couldn&rsquo;t find any workloads associated with app noteapp, try initializing one: copilot [svc/job] init .<br>
✘ select a workload from noteapp : no workloads found in noteapp</p>
</blockquote>
<p>Well, the problem is obvious, I cannot deploy a storage service unless I create a service first and by service I mean containerized application.</p>
<p>I walked through the documentation again, and I found a magical feature that says &ldquo;Modeling Additional Environment Resources with AWS CloudFormation&rdquo;, this feature gave me the ability to deploy resources on an environment based.</p>
<p>That gave me goosebumps to understand CloudFormation, as it seems crucial in the next phases. The methodology was deploying a demo architecture to get comfortable with the services and the whole flow, I deployed one of the well-known architectures which is <strong>lambda function &amp; DynamoDB</strong> and here is my recap</p>
<p>CloudFormation file structure consists of 3 main blocks <strong>Parameters</strong> (Optional), <strong>Resources</strong> (Required), and <strong>Outputs</strong> (Optional).</p>
<ul>
<li><strong>Resources</strong> block encapsulate the services we need to deploy, Each service requires 2 properties <strong>Type, Properties</strong> and each service has different Properties, an example of that for <code>Lambda Function</code> there are <strong>Handler</strong> , <strong>Runtime</strong> , <strong>Code</strong> properties while on <code>DynamoDB::Table</code> there are different properties <strong>AttributeDefinitions</strong> , <strong>KeySchema</strong> , <strong>ProvisionedThroughput</strong></li>
</ul>
<!-- raw HTML omitted -->
<p>Now, AWS CLI has a built-in command for managing CloudFormation files, to create resources the first time the command is</p>
<pre><code>aws cloudformation create-stack --stack-name resource_stack --template-body file://cloudformation.yml --capabilities CAPABILITY_NAMED_IAM
</code></pre>
<p>and for update</p>
<pre><code>aws cloudformation update-stack --stack-name resource_stack --template-body file://cloudformation.yml --capabilities CAPABILITY_NAMED_IAM
</code></pre>
<p>An additional cool feature of AWS CloudFormation is the built-in managing dashboard where you can see your stacks and their status</p>
<!-- raw HTML omitted -->
<p>Then I started to think about integrating CloudFormation with Copilot until I looked through the window, and it was almost dark and my back was hurting, so I took the sign and went for a little bit of social life</p>
]]></content:encoded>
    </item>
    <item>
      <title>GCP -&gt; AWS Migration: Determination</title>
      <link>//localhost:1313/posts/determination/</link>
      <pubDate>Sun, 16 Apr 2023 16:05:46 +0100</pubDate>
      <guid>//localhost:1313/posts/determination/</guid>
      <description>You know that feeling ?, when you&amp;rsquo;re escaping a bad documentation, instead crawling around searching for a solution, and you find a snippet of code on Stack Overflow or Reddit, after you copy and paste it, it doesn&amp;rsquo;t work then your mind tells you &amp;ldquo;you need to change it a little bit&amp;rdquo;.
So you start changing the code to solve your problem, and guess what? A hell of a lot of new terminology and ideas enter your mind, and you start to get confused.</description>
      <content:encoded><![CDATA[<blockquote>
<p>You know that feeling ?, when you&rsquo;re escaping a bad documentation, instead crawling around searching for a solution, and you find a snippet of code on Stack Overflow or Reddit, after you copy and paste it, it doesn&rsquo;t work then your mind tells you &ldquo;you need to change it a little bit&rdquo;.<br>
So you start changing the code to solve your problem, and guess what? A hell of a lot of new terminology and ideas enter your mind, and you start to get confused. Well, I Hamza Bou Issa am in that state of mind.</p>
</blockquote>
<p>The last time I was left in &ldquo;Deploying RDS with copilot using CloudFormation&rdquo;, Yeah my approach to solving the problem is the same as before, typing a bunch of keywords and questions into Google, clicking on the first few links, if Stack Overflow then I detect responses with green mark and copy code, if it&rsquo;s an article, I find snippets and copy the ones that have RDS or DB on them</p>
<p>I took the time to understand CloudFormation file structure and a few resource types</p>
<p>At first, I found this snippet</p>
<pre><code># Set AWS template version
AWSTemplateFormatVersion: &quot;2010-09-09&quot;
# Set Parameters
Parameters:
  EngineVersion:
    Description: PostgreSQL version.
    Type: String
    Default: &quot;14.1&quot;
  SubnetIds:
    Description: Subnets
    Type: &quot;List&lt;AWS::EC2::Subnet::Id&gt;&quot;
  VpcId:
    Description: Insert your existing VPC id here
    Type: String

Resources:
  DBSubnetGroup:
    Type: &quot;AWS::RDS::DBSubnetGroup&quot;
    Properties:
      DBSubnetGroupDescription: !Ref &quot;AWS::StackName&quot;
      SubnetIds: !Ref SubnetIds

  DatabaseSecurityGroup:
    Type: &quot;AWS::EC2::SecurityGroup&quot;
    Properties:
      GroupDescription: The Security Group for the database instance.
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432

  DBInstance:
    Type: &quot;AWS::RDS::DBInstance&quot;
    Properties:
      AllocatedStorage: &quot;30&quot;
      DBInstanceClass: db.t4g.medium
      DBName: &quot;postgres&quot;
      DBSubnetGroupName: !Ref DBSubnetGroup
      Engine: postgres
      EngineVersion: !Ref EngineVersion
      MasterUsername: username
      MasterUserPassword: password
      StorageType: gp2
      MonitoringInterval: 0
      VPCSecurityGroups:
      - !Ref DatabaseSecurityGroup
</code></pre>
<p>The following code will create 3 resources: <strong>DbInstance</strong> , <strong>DatabaseSecurityGroup</strong> , <strong>DBSubnetGroup</strong> , From my understanding the connection between those resources is a Database need to be created on private <strong>Subnets(DBSubnetGroup)</strong> on the other side for the database to accept connection it needs a security group( <strong>DatabaseSecurityGroup</strong> ) which should be on the same <strong>VPC</strong> as the <strong>Subnets</strong></p>
<p>Now before I paste this code into <!-- raw HTML omitted -->environment/addons/rds.yml<!-- raw HTML omitted -->, I&rsquo;m going to remove the parameters as we have an alternate method of passing the <strong>SubnetIds</strong> and <strong>VpcId</strong>.</p>
<p>CloudFormation gives the ability to import resources from previously created stacks with <code>Fn::ImportValue</code> function. In this case, after I run <code>copilot env deploy --name test</code> . Copilot create 2 CloudFormation stacks</p>
<!-- raw HTML omitted -->
<p>The first stack is the interesting one, after we open on <strong>mycompany-app-test</strong> stack, we click on the Outputs panel, and it should show us the created resources with export names that can be imported on our RDS stack.</p>
<!-- raw HTML omitted -->
<p>The two interesting export names are <strong>mycompany-app-test-PrivateSubnets</strong> , <strong>mycompany-app-test-VpcId</strong> , let&rsquo;s refactor our rds.yml file and add them</p>
<pre><code># Set AWS template version
AWSTemplateFormatVersion: &quot;2010-09-09&quot;
# Set Parameters
Parameters:
  App:
    Type: String
    Description: Your application's name.
  Env:
    Type: String
    Description: The environment name your service, job, or workflow is being deployed
  Name:
    Type: String
    Description: The name of the service, job, or workflow being deployed.

Resources:
  DBSubnetGroup:
    Type: &quot;AWS::RDS::DBSubnetGroup&quot;
    Properties:
      DBSubnetGroupDescription: !Ref &quot;AWS::StackName&quot;
      SubnetIds:
        !Split [',', { 'Fn::ImportValue': !Sub '${App}-${Env}-PrivateSubnets'}]
  DatabaseSecurityGroup:
    Type: &quot;AWS::EC2::SecurityGroup&quot;
    Properties:
      GroupDescription: The Security Group for the database instance.
      VpcId:
        Fn::ImportValue: !Sub '${App}-${Env}-VpcId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0

  DBInstance:
    Type: &quot;AWS::RDS::DBInstance&quot;
    Properties:
      AllocatedStorage: &quot;30&quot;
      DBInstanceClass: db.t4g.medium
      DBName: &quot;postgres&quot;
      DBSubnetGroupName: !Ref DBSubnetGroup
      Engine: postgres
      EngineVersion: &quot;14.1&quot;
      MasterUsername: username
      MasterUserPassword: password
      StorageType: gp2
      MonitoringInterval: 0
      VPCSecurityGroups:
      - !Ref DatabaseSecurityGroup
</code></pre>
<p>As you see, I removed the previous parameters and replace them with a few parameters <strong>App</strong> , <strong>Env</strong> , <strong>Name</strong> which is copilot required add-ons parameters. Also for SubnetIds I import PrivateSubnets and split it because it must be passed as separate values</p>
<p>After I run <code>copilot env deploy --name test</code> a nested stack will get created</p>
<!-- raw HTML omitted -->
<p>But how I&rsquo;m going to test if the database is working or accepting connection while it&rsquo;s not reachable on the public internet, well it seems I can create an ec2 instance on the public subnet and allow connection with the security group.</p>
<p>Here is the refactored code</p>
<pre><code># Set AWS template version
AWSTemplateFormatVersion: &quot;2010-09-09&quot;
# Set Parameters
Parameters:
  App:
    Type: String
    Description: Your application's name.
  Env:
    Type: String
    Description: The environment name your service, job, or workflow is being deployed to.

 
Resources:
  DBSubnetGroup:
    Type: &quot;AWS::RDS::DBSubnetGroup&quot;
    Properties:
      DBSubnetGroupDescription: !Ref &quot;AWS::StackName&quot;
      SubnetIds:
        !Split [',', { 'Fn::ImportValue': !Sub '${App}-${Env}-PrivateSubnets' }]
  
  DatabaseSecurityGroup:
    Type: &quot;AWS::EC2::SecurityGroup&quot;
    Properties:
      GroupDescription: The Security Group for the database instance.
      VpcId: 
        Fn::ImportValue:
          !Sub '${App}-${Env}-VpcId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0
  
  DBInstance:
    Type: &quot;AWS::RDS::DBInstance&quot;
    Properties:
      AllocatedStorage: &quot;30&quot;
      DBInstanceClass: db.t4g.medium
      DBName: &quot;postgres&quot;
      DBSubnetGroupName: !Ref DBSubnetGroup
      Engine: postgres
      EngineVersion: &quot;14.1&quot;
      MasterUsername: username
      MasterUserPassword: password
      StorageType: gp2
      MonitoringInterval: 0
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub 'copilot-${App}-${Env}'

  NewKeyPair:
    Type: 'AWS::EC2::KeyPair'
    Properties:
      KeyName: !Sub ${App}-${Env}-EC2-RDS-KEYPAIR
      Tags:
        - Key: Name
          Value: !Sub 'copilot-${App}-${Env}'
  
  EC2SecuityGroup:
    Type: &quot;AWS::EC2::SecurityGroup&quot;
    Properties:
      GroupDescription: The Security Group for the ec2 instance.
      VpcId: 
        Fn::ImportValue:
          !Sub '${App}-${Env}-VpcId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub 'copilot-${App}-${Env}'
        
  Ec2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      ImageId: ami-05e8e219ac7e82eba
      InstanceType: t2.micro
      KeyName: !Ref NewKeyPair
      SubnetId: !Select [&quot;0&quot;,!Split [',', { 'Fn::ImportValue': !Sub '${App}-${Env}-PublicSubnets' }]]
      SecurityGroupIds:
        - !Ref EC2SecuityGroup
      
      UserData: |
        #!/bin/bash
        sudo apt update
        sudo apt upgrade
        sudo apt install postgresql postgresql-contrib


      Tags:
        - Key: Name
          Value: !Sub 'copilot-${App}-${Env}'
      


Outputs:
  ServerPublicDNS:
    Description: &quot;Public DNS of EC2 instance&quot;
    Value: !GetAtt Ec2Instance.PublicDnsName

  DatabaseEndpoint:
    Description: &quot;Connection endpoint for the database&quot;
    Value: !GetAtt DBInstance.Endpoint.Address
</code></pre>
<p>A few things to notice, I added an Ec2Instance on a public subnet, a security group that allows only ssh port (22), meanwhile, the ImageId, InstanceType property are more tied to the region you&rsquo;re deploying to, I am using eu-west-3(I&rsquo;m not a French guy -_-). NewKeyPair is the ssh key to log into EC2, and finally the Outputs section for getting the EC2 instance and Database connection URL</p>
<p>I rerun <code>copilot env deploy --name test</code> , wait for the stack to update, before connecting to ec2 an ssh file must be downloaded, the ssh key pair will be saved on AWS Parameter Store, here are the following steps to download it</p>
<pre><code>aws ec2 describe-key-pairs --filters Name=key-name,Values=mycompany-app-test-E
</code></pre>
<p>The above command output.</p>
<pre><code>key-05abb699beEXAMPLE
</code></pre>
<p>and to save the ssh key value</p>
<pre><code>aws ssm get-parameter --name /ec2/keypair/key-05abb699beEXAMPLE --with-decrypt
</code></pre>
<p>Now, After I get the ssh file, try to connect to the server</p>
<pre><code>ssh -i new-key-pair.pem ubuntu@ec2-host
</code></pre>
<p>I try to connect to RDS</p>
<pre><code>psql -U username -d postgres -h database_host
</code></pre>
<!-- raw HTML omitted -->
]]></content:encoded>
    </item>
    <item>
      <title>GCP -&gt; AWS Migration: The Search</title>
      <link>//localhost:1313/posts/the-search/</link>
      <pubDate>Wed, 12 Apr 2023 15:28:36 +0100</pubDate>
      <guid>//localhost:1313/posts/the-search/</guid>
      <description>Key points wake up with an email deciding not to go to the workspace read the task description and start searching lay on the bed again, thinking of ways to approach the problem get up and write his thoughts in his journal Search again and find copilot as a solution his alarm bumps for taking a walk It&amp;rsquo;s 8:35 AM, and the phone started vibrating with notifications, he used to receive the &amp;ldquo;Good Morning Babe&amp;rdquo; message from his girlfriend with a few newsletters emails, but this time, it was an email on his Zoho mail with the Subject: [JIRA] Yassine assigned DEV-550 to you</description>
      <content:encoded><![CDATA[<h2 id="key-points"><strong>Key points</strong></h2>
<ul>
<li>wake up with an email</li>
<li>deciding not to go to the workspace</li>
<li>read the task description and start searching</li>
<li>lay on the bed again, thinking of ways to approach the problem</li>
<li>get up and write his thoughts in his journal</li>
<li>Search again and find copilot as a solution</li>
<li>his alarm bumps for taking a walk</li>
</ul>
<p>It&rsquo;s 8:35 AM, and the phone started vibrating with notifications, he used to receive the &ldquo;Good Morning Babe&rdquo; message from his girlfriend with a few newsletters emails, but this time, it was an email on his Zoho mail with the Subject: <strong>[JIRA] Yassine assigned DEV-550 to you</strong></p>
<p>He opened his JIRA account from his phone, he was assigned a single task with the title</p>
<!-- raw HTML omitted -->
<p>He didn&rsquo;t take a deep look at the description, but he felt he wasn&rsquo;t in the mood to go to the workspace, so he sent a message to the company Slack channel stating he is going to work from home today.</p>
<p>Took a quick bath, eat breakfast and returned to the desk, he opened again the JIRA task and now taking a better look at the description by catching some keywords: DEV Environment, VPC, Subnet, Route Table, LoadBalancer, Database, Redis, Containers, IAC</p>
<p>He wasn&rsquo;t familiar with the majority of keywords, and this was an advantage to stimulate him for learning.  50 min passes and he should take a break for 20 min as he follows The 50-Minute Focus Technique, but it doesn&rsquo;t seem he cares, his eyes are filled with passion for finding the solution, he knew there is no direct tutorial or article to his problem.</p>
<p>His browser was filled with tabs of random articles with a side note app to summarise what he understood from each article</p>
<p>He lay down on the bed, taking a break and connecting the dots. The task seemed more clear now, but time was a crucial factor, he was telling himself</p>
<blockquote>
<p><em>I pretty understand the workflow I should take but hmmm,but 3 weeks doesn&rsquo;t seem a lot of time, so let me find a tool to help me speed up the process and doesn&rsquo;t hook me up into much networking details for now</em></p>
</blockquote>
<blockquote>
<p><em>Let me take a nap for now</em></p>
</blockquote>
<p>It was 3:51 PM, and this time he woke up prepared, he took his pc while lying on his bed. The goal is to find a solution to help him speed up building the infrastructure, A quick search leads him to a few tools like Terraform, Ansible, CloudFormation, Puppet, Vagrant</p>
<p>But it didn&rsquo;t seem the final result, Terraform &amp; CloudFormation were IAC( Infrastructure as Code) tools an abstraction over cloud provider Rest API, Ansible and Puppet were Configuration Management tools he doesn&rsquo;t need for now and a vagrant is a virtualization tool which was away from his needs.</p>
<!-- raw HTML omitted -->
<p>In the same way, he was eager to find a tool to work on top of CloudFormation, he was typing all sorts of keywords around CloudFormation and IAC tools like &ldquo;Tools that use CloudFormation, AWS open source projects for building networking infrastructure, What better than CloudFormation, CloudFormation Cons, CloudFormation Alternatives&rdquo;</p>
<p>As a consequence, the results were somehow near his needs, he found a few tools to compare them and decide which one to go with</p>
<ul>
<li><a href="https://docs.aws.amazon.com/cdk/v2/guide/about_examples.html">AWS CDK</a></li>
<li><a href="https://www.waypointproject.io/">HashiCorp WAYPOINT</a></li>
<li><a href="https://aws.github.io/copilot-cli/docs">AWS Copilot</a></li>
<li><a href="https://aws.amazon.com/amplify/">AWS Amplify</a></li>
<li><a href="https://github.com/hamzabouissi/fissaa">Fissaa</a></li>
</ul>
<p>How extendible the tool is, How much is supported by the community if it&rsquo;s open source(GitHub Starts, pull request, issues), learning curve, have additional and unique features. Those were the criteria he judged upon choosing his next tool, for better clarity he created a table where he assigned each one a score</p>
<!-- raw HTML omitted -->
<p>After calculating the scores, AWS Copilot won the battle by how much is can be extendible into adding CloudFormation files, the community is quite good with 2.7k stars and few issues and on the pull requests side people seems interested in developing features on it, the learning curve scored 6 because documentation was pretty clear, and they have tutorial section and AWS is investing some videos also, it scored the highest on unique features because it helps deploy storage services(S3, Aurora, DynamoDB), customizing the underlying infrastructure like Subnet, NAT, Load Balancer&hellip;etc.</p>
<p>It&rsquo;s 7:19 PM, and the alarm rings saying &ldquo;30-min Walk&rdquo;&hellip;</p>
]]></content:encoded>
    </item>
    <item>
      <title>GCP -&gt; AWS Migration: The Beginning</title>
      <link>//localhost:1313/posts/the-beginning/</link>
      <pubDate>Mon, 10 Apr 2023 15:25:26 +0100</pubDate>
      <guid>//localhost:1313/posts/the-beginning/</guid>
      <description>Key Points: the boy is still an amateur, this is his first experience of him with DevOps the boy lacks some social skills the Startup CEO calls him he got the task of migrating the stack from GCP to AWS he returns confused and scared of not finding a solution then he goes back home, locks the room door and Lay on the bed imagining the way He was standing in front of the Nespresso machine, waiting for his daily caffeine fix, but his ears were inadvertently eavesdropping on the conversation of his two colleagues.</description>
      <content:encoded><![CDATA[<h3 id="key-points">Key Points:</h3>
<ul>
<li>the boy is still an amateur, this is his first experience of him with DevOps</li>
<li>the boy lacks some social skills</li>
<li>the Startup CEO calls him</li>
<li>he got the task of migrating the stack from GCP to AWS</li>
<li>he returns confused and scared of not finding a solution</li>
<li>then he goes back home, locks the room door and Lay on the bed imagining the way</li>
</ul>
<p>He was standing in front of the Nespresso machine, waiting for his daily caffeine fix, but his ears were inadvertently eavesdropping on the conversation of his two colleagues.</p>
<blockquote>
<p><em>The page will take too long if you make that many requests to the backend</em></p>
</blockquote>
<blockquote>
<p><em>Shouldn&rsquo;t we talk to the backend team to create one API to post all JSON data?&quot; one colleague suggested.</em></p>
</blockquote>
<p>He didn&rsquo;t keep listening after he smelled the aroma of his coffee. He took his coffee and went back to his desk. As a Backend Developer, he scrolled up and down, examining the project&rsquo;s code and searching for any opportunities for optimization or refactoring.</p>
<p>An hour passed, and he grew bored. He played the Spotify playlist &ldquo;Lofi Electronic mix&rdquo; and then slumped in his chair, wondering what life would be like after one year of professional experience. It was the smile on his face that reflected that he was moving closer to his dreams. That moment was the missing key to escaping boredom.</p>
<p>While wandering in his imagination, he felt a hand on his shoulder. He opened his eyes and saw the CTO in front of him. He was embarrassed and suddenly fell off the chair. The CTO laughed and asked if he was okay. He replied</p>
<blockquote>
<p><em>Yeah, all good, thanks. I was thinking about some optimization, and I was closing my eyes to avoid getting distracted</em></p>
</blockquote>
<blockquote>
<p><em>Yep, sure. Sorry for disturbing you. Can I have a moment of your time to discuss something?&quot; the CTO asked.</em></p>
</blockquote>
<p>He followed him to the office, sat down, and waited for the CTO to finish sending the email. He couldn&rsquo;t stop asking himself if he was going to be fired or not. His heart jumped out of fear. Then the CTO said,</p>
<blockquote>
<p><em>I received an email from GCP (Google Cloud Platform) that they will not give us more credit after the next two months. So we thought of migrating to AWS since it gives us one year of free usage on some services. We can benefit from the wide range of services that it provides. I called you because I know you have some sort of Networking knowledge and skills as you worked with some projects on university, and I wanted to ask if you&rsquo;re interested</em></p>
</blockquote>
<blockquote>
<p><em>To be honest with you, I dont have that much experience with AWS, but I just did basic configuration of  EC2 instances, that&rsquo;s all.</em></p>
</blockquote>
<blockquote>
<p><em>Hmm, Understood, So are you willing to face more challenges and develop yourself on the cloud project ?</em></p>
</blockquote>
<blockquote>
<p><em>Okey, I think it will be a good experience to  prove myself and my skills, I&rsquo;m In</em></p>
</blockquote>
<blockquote>
<p><em>Okay, sounds good. I will tell the backend senior that you moved to the DevOps team and send you the required tasks and GCP credentials</em></p>
</blockquote>
<blockquote>
<p><em>Can I ask who is with me on the team ?</em></p>
</blockquote>
<blockquote>
<p><em>No one, just you</em></p>
</blockquote>
<p>He left the office, feeling a mix of curiosity and fear. He packed his laptop, put on his headphones, and walked back home.</p>
<p>As he walked through the door of his apartment, he took off his shoes and fell onto the couch. His mind was racing with thoughts about the upcoming project and the opportunity that lay ahead of him. He was excited about the prospect of working with AWS and learning more about DevOps.</p>
<p>He spent the rest of the evening researching AWS services and watching tutorials on how to use them. He was determined to be well-prepared for the task ahead. As the night wore on, he grew tired and went to bed, dreaming about the possibilities that awaited him</p>
]]></content:encoded>
    </item>
    <item>
      <title>Deployment Preview with AWS CloudFront</title>
      <link>//localhost:1313/posts/deployment-preview-with-aws-cloudfront/</link>
      <pubDate>Tue, 10 Jan 2023 11:39:04 +0100</pubDate>
      <guid>//localhost:1313/posts/deployment-preview-with-aws-cloudfront/</guid>
      <description>Introduction Deploy Previews allow you and your team to experience changes to any part of your site without having to publish them to production.
With a deploy previews feature you and your teammates can see the changes of every pull request you make without merging it, this will reduce the burden of rolling back the environment when bugs happen as you can review the changes before.
In this tutorial, you’ll learn about creating a CI pipeline with CodeBuild that gets triggered on every pull request creation or update, for every build we host react build folder on an S3 bucket and serve it with Cloudfront, finally after merging the pull request, we delete the build folder from S3.</description>
      <content:encoded><![CDATA[<h3 id="introduction"><strong>Introduction</strong></h3>
<p>Deploy Previews allow you and your team to experience changes to any part of your site without having to publish them to production.</p>
<p>With a deploy previews feature you and your teammates can see the changes of every pull request you make without merging it, this will reduce the burden of rolling back the environment when bugs happen as you can review the changes before.</p>
<p>In this tutorial, you’ll learn about creating a CI pipeline with CodeBuild that gets triggered on every pull request creation or update, for every build we host react build folder on an S3 bucket and serve it with Cloudfront, finally after merging the pull request, we delete the build folder from S3.</p>
<p>In the end, this tutorial will expand your knowledge of AWS Services and help you speed up your development and deployment process.</p>
<p>Before starting, here is a playlist to enjoy reading with</p>
<!-- raw HTML omitted -->
<p>To accomplish this tutorial, you’ll need:</p>
<ul>
<li>an AWS account with administrative permissions</li>
<li>an AWS CLI with a minimum version of 2.4.6</li>
<li>a runnable React app hosted on GitHub</li>
<li>basic knowledge of YAML file structure</li>
<li>clone this <a href="https://github.com/hamzabouissi/simple-react-app">simple react app</a></li>
</ul>
<h2 id="creating-ci-pipeline"><strong>Creating CI Pipeline</strong></h2>
<p>To build a resilient system, you need to add tests on your code then run them locally and on every push to version control. In this step, you will build a CI pipeline that triggers every pull request creation or update on your GitHub repository, the pipeline will run the desired tests and return a badge containing the status of the tests to your GitHub.</p>
<p>Create the file  pull-request.yml  in your text editor:</p>
<pre><code>nano pull-request.yml
</code></pre>
<p>Add the following CloudFormation code to the file, which builds a CodeBuildProject that defines a CI pipeline with GitHub integration:</p>
<pre><code>Resources:
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: FrontBuildOnPull
      ServiceRole: !GetAtt BuildProjectRole.Arn
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Ref BuildLogGroup
          Status: ENABLED
          StreamName: front_pull_request
      EncryptionKey: &quot;alias/aws/s3&quot;
      Artifacts:
        Type: S3
        Location: !Ref ArtifactBucket
        Name: FrontPullRequest
        OverrideArtifactName: true
        EncryptionDisabled: true
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
       
      Source:
        Type: GITHUB
        Location: &quot;https://github.com/projectX/repoY&quot;
        ReportBuildStatus: true
      Triggers:
        BuildType: BUILD
        Webhook: true
        FilterGroups:
          - - Type: EVENT
              Pattern: PULL_REQUEST_CREATED,PULL_REQUEST_UPDATED
      Visibility: PUBLIC_READ
      ResourceAccessRole: !Ref PublicReadRole
</code></pre>
<p>I will briefly explain the CloudFormation template structure, so you can get a general understanding of CloudFormation files that guides you through the next steps.</p>
<p>The majority of CloudFormation template files will contain Parameters(Optional) and Resources(Required), Outputs(Optional), each block on the Resources is a Service, and every Service contains Type and Properties. The type is referred to as AWS Service or a Custom Function and each Type has a different set of properties.</p>
<p>Let’s analyze the above Code to understand better. Here we have a Resources block that contains three Services. The CodeBuildProject refers to AWS::CodeBuild::Project which is an AWS Service for <a href="https://aws.amazon.com/codebuild/">CodeBuild</a>. The CodeBuild has a set of properties, you can find them here <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-project.html">properties</a>, I will explain each property functionality and why we’re adding it.</p>
<h3 id="give-codebuild-the-required-permissions"><strong>Give CodeBuild the required permissions</strong></h3>
<p>For CodeBuild to work we need to assign the ServiceRole an IAM Role to give CodeBuild the right to access other AWS services like secrets, S3, and logs.</p>
<pre><code>  ...
  ServiceRole: !GetAtt BuildProjectRole.Arn
  ...
  ...
</code></pre>
<p><!-- raw HTML omitted -->BuildProjectRole<!-- raw HTML omitted --> is a role that assumes the principal “codebuild.amazonaws.com” the permission to use a set of services on our behalf of us, more reading about <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html">AWS::IAM::ROLE</a></p>
<p>After, we need to ask ourselves what services CodeBuild must have access to and what we want to access on each of the services:</p>
<ul>
<li>Codebuild needs to create and update the test reports.</li>
<li>CodeBuild needs to store the CI process logs inside a logs group.</li>
<li>CodeBuild needs to access the secrets manager to get some secret credentials ex: CYPRESS_KEY. - CodeBuild needs to get and store React build folder on S3.</li>
</ul>
<p>Now after we defined our requirements, we create BuildProjectPolicy which is an <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-policy.html">AWS::IAM::Policy</a> for BuildProjectRole that contains the list of statements, and each statement is composed of a set of actions.</p>
<pre><code>BuildProjectRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      
  BuildProjectPolicy:
    Type: AWS::IAM::Policy
    DependsOn: BuildProjectRole
    Properties:
      PolicyName: !Sub ${AWS::StackName}-CodeBuildPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - codebuild:CreateReportGroup
              - codebuild:CreateReport
              - codebuild:UpdateReport
              - codebuild:BatchPutTestCases
              - codebuild:BatchPutCodeCoverages
            # Create and update test report

            Resource: &quot;*&quot;
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:GetObjectVersion
            # Get and store React build folder on S3

            Resource: &quot;*&quot;
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            # Store the CI process logs inside a logs group
            Resource: arn:aws:logs:*:*:*
          - Effect: Allow
            Action:
              - secretsmanager:*
            # Get secret creedentials ex: CYPRESS_KEY
            
            Resource: &quot;*&quot;
      Roles:
        - !Ref BuildProjectRole
</code></pre>
<h3 id="access-and-store-codebuild-logs"><strong>Access and Store CodeBuild Logs</strong></h3>
<p>Logs are an important key of DevOps because it adds the visibility aspect to the infrastructure, so gather logs as much as you can. In our case, to enable logs for <!-- raw HTML omitted -->CodeBuild<!-- raw HTML omitted --> project we create <!-- raw HTML omitted -->LogsConfig<!-- raw HTML omitted --> property.</p>
<pre><code>  ...
  ...
  LogsConfig:
    CloudWatchLogs:
      GroupName: !Ref BuildLogGroup
      Status: ENABLED
      StreamName: front_pull_request
  ...
  ...
</code></pre>
<p>Now, we need to create a <!-- raw HTML omitted -->LogGroup<!-- raw HTML omitted --> to which CodeBuild pushes logs to</p>
<pre><code>BuildLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: frontend_build_on_pull
      RetentionInDays: 7
</code></pre>
<p><!-- raw HTML omitted -->RetentionInDays<!-- raw HTML omitted --> is the period after which the logs expire.</p>
<h3 id="access-and-store-react-builds"><strong>Access and Store React Builds</strong></h3>
<p>After successfully building and testing the project, we should store the build folder on S3 so we can access it again when the developer wants to see his changes. So we create an Artifacts property that stores build on an S3 bucket called “ArtifactBucket”</p>
<pre><code>  ...
  ...
  Artifacts:
    Type: S3
    Location: !Ref ArtifactBucket
    Name: FrontPullRequest
    OverrideArtifactName: true
    EncryptionDisabled: true
  ...
  ...
</code></pre>
<p><!-- raw HTML omitted -->OverrideArtifactName<!-- raw HTML omitted --> we use to customize the path where we store the builds.</p>
<p><!-- raw HTML omitted -->EncryptionDisabled<!-- raw HTML omitted --> we disabled it because we don’t need custom encryption in our case, we will be using the default one instead.</p>
<pre><code>ArtifactBucket:
  Type: 'AWS::S3::Bucket'
  DeletionPolicy: Delete
  Properties:
    BucketName: &quot;some-random-unique-bucket-name&quot;
    BucketEncryption:
      ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
    PublicAccessBlockConfiguration:
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true
</code></pre>
<p><!-- raw HTML omitted -->ArtifactBucket<!-- raw HTML omitted --> is a resource block that refers to AWS::S3::Bucket, also we should add some properties to restrict public access to build folders and define how the data must be encrypted when it gets stored.</p>
<p><!-- raw HTML omitted -->Name<!-- raw HTML omitted -->: you need to change to your unique bucket name, the name must be unique across all AWS buckets.</p>
<p><!-- raw HTML omitted -->BucketEncryption<!-- raw HTML omitted --> we use Amazon S3 server-side encryption which uses 256-bit Advanced Encryption Standard(AES256).</p>
<p><!-- raw HTML omitted -->PublicAccessBlockConfiguration<!-- raw HTML omitted --> this property blocks all public access to the public and ignores any policy that allows public visibility of the bucket.</p>
<h3 id="codebuild-ci-environment"><strong>CodeBuild CI Environment</strong></h3>
<p>For the CI to work, you must provide information about the CI environment. A build environment represents a combination of the operating system, programming language runtime, and tools that CodeBuild uses to run a build.</p>
<pre><code>  ...
  ...
  Environment:
    Type: LINUX_CONTAINER
    ComputeType: BUILD_GENERAL1_MEDIUM
    Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
  ...
</code></pre>
<p><!-- raw HTML omitted -->Type<!-- raw HTML omitted --> this is the OS type, which is Linux for our case.</p>
<p><!-- raw HTML omitted -->ComputeType<!-- raw HTML omitted -->: this provides the CodeBuild with information about the computing resources it’s allowed to use (7 GB Memory,4vCPU,128GB Disk ).</p>
<p><!-- raw HTML omitted -->Image<!-- raw HTML omitted -->: A docker image to use during the build which provides the environment with a set of tools and runtimes, here is the <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-available.html">documentation</a> for better details</p>
<h3 id="codebuild-trigger-and-repo-linking"><strong>CodeBuild Trigger and Repo Linking</strong></h3>
<p>To fire up the build process whenever a pull request is created or updated, you need to add two properties: Source, Triggers</p>
<pre><code>  ...
  ...
  Source:
    Type: GITHUB
    Location: &quot;https://github.com/projectX/repoY&quot;
    ReportBuildStatus: true
  Triggers:
    BuildType: BUILD
    Webhook: true
    FilterGroups:
      - - Type: EVENT
          Pattern: PULL_REQUEST_CREATED,PULL_REQUEST_UPDATED
  ...
  ...
</code></pre>
<p><!-- raw HTML omitted -->Source<!-- raw HTML omitted --> defines the type of version control and the location, you need to change the <!-- raw HTML omitted -->Location<!-- raw HTML omitted --> property to your desired repository, on the other side to report the build status back to version control(Github) you turn <!-- raw HTML omitted -->ReportBuildStatus<!-- raw HTML omitted --> to true. <!-- raw HTML omitted -->Triggers<!-- raw HTML omitted --> specify webhooks that trigger The AWS CodeBuild build.</p>
<p>To allow Codebuild access to your repository, you need to create a personal access token and pass it to CodeBuild so it can access your repo on your behalf, This can be done in two steps:</p>
<p>1- Generate a personal token from your GitHub account:</p>
<p>Visit the <a href="https://github.com/settings/tokens/new">Personal access tokens Github page</a>, then select “Full control of private repositories” and “Full control of repository hooks” and click Generate token.</p>
<p>2- Pass down the generated token to AWS Codebuild credentials: Run the following command to generate an import-source-credentials.json  file on your local :</p>
<pre><code>aws codebuild import-source-credentials --generate-cli-skeleton
</code></pre>
<p>After, we need to modify  import-source-credentials.json  and fill it with your credentials:</p>
<ul>
<li>
<p>auth_type: PERSONAL_ACCESS_TOKEN</p>
</li>
<li>
<p>serverType: GITHUB</p>
</li>
<li>
<p>username: your GitHub username</p>
</li>
<li>
<p>token: the generated token from the previous step.</p>
<p>aws codebuild import-source-credentials &ndash;cli-input-json file://import-source-credentials.json</p>
</li>
</ul>
<p>To test that your command runs successfully, run the following command to list your CodeBuild credentials:</p>
<pre><code>aws codebuild list-source-credentials
</code></pre>
<p>Now when CodeBuild starts running it will search in your source code for a file named buildspec.yml, by definition :</p>
<p>A <em><!-- raw HTML omitted -->buildspec<!-- raw HTML omitted --></em> is a collection of build commands and related settings, in YAML format, that CodeBuild uses to run a build.</p>
<p>Here is an example of buildspec.yml from our demo app :</p>
<pre><code>version: 0.2

phases:
  install:
    commands:
      - npm install 
  pre_build:
    on-failure: ABORT
    commands:
      - echo &quot;run some pre-check&quot;
      #- npm run format:check
      #- npm run lint:check
  build:
    on-failure: ABORT
    commands:
      - echo &quot;run tests&quot;
      # - npm run-script start &amp; npx wait-on http://localhost:3000
      # - npx cypress run --record --key ${CYPRESS_KEY}

  post_build:
    commands:
      - |
          npm run build

artifacts:
  # include all files required to run application
  # we include only the static build files
  files:
    - '**/*'
  name: $CODEBUILD_WEBHOOK_TRIGGER
  base-directory: 'dist'
</code></pre>
<p>Our CI contains different phases (install, pre_build …etc), finally, post_build will run when all the previous steps exited successfully.</p>
<p><!-- raw HTML omitted -->post_build<!-- raw HTML omitted --> will create a  dist folder and then CodeBuild will upload the dist folder to S3 under CODEBUILD_WEBHOOK_TRIGGER path that will be  /pr/{pr_number}.</p>
<p>For example, if a pull request gets created with the number 1, then after CI builds successfully the build folder will get stored on ArtifactBucket under path <strong>/pr/1/</strong>.</p>
<h3 id="ci-logs-public-visibility-to-users"><strong>CI logs Public Visibility To Users</strong></h3>
<p>The following property gives developers access to see build logs without having an AWS account :</p>
<pre><code>...
...
Visibility: PUBLIC_READ
ResourceAccessRole: !Ref PublicReadRole
...
</code></pre>
<p>then the PublicReadRole must allow access to logs and S3</p>
<pre><code>  PublicReadRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: ['sts:AssumeRole']
            Effect: Allow
            Principal:
              Service: [codebuild.amazonaws.com]
        Version: '2012-10-17'
      Path: /

  PublicReadPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: PublicBuildPolicy
      PolicyDocument:
        Version: &quot;2012-10-17&quot;
        Statement:
          - Effect: Allow
            Action:
              - &quot;logs:GetLogEvents&quot;
            Resource:
              - !Sub &quot;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${BuildLogGroup}:*&quot;
          - Effect: Allow
            Action:
              - &quot;s3:GetObject&quot;
              - &quot;s3:GetObjectVersion&quot;
            Resource:
              - Fn::Sub:
                - &quot;${ArtifcatArn}/*&quot;
                - {ArtifcatArn: !GetAtt ArtifactBucket.Arn}
      Roles:
        - !Ref PublicReadRole
</code></pre>
<h3 id="sum-it-up"><strong>Sum It Up</strong></h3>
<p>After you understand the full picture of CodeBuild Service and its dependency, you can edit pull-request.yml:</p>
<pre><code>nano pull-request.yml
</code></pre>
<p>replace its content with the following code</p>
<pre><code>Resources:
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: FrontBuildOnPull
      ServiceRole: !GetAtt BuildProjectRole.Arn
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Ref BuildLogGroup
          Status: ENABLED
          StreamName: front_pull_request
      EncryptionKey: &quot;alias/aws/s3&quot;
      Artifacts:
        Type: S3
        Location: !Ref ArtifactBucket
        Name: FrontPullRequest
        OverrideArtifactName: true
        EncryptionDisabled: true
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
       
      Source:
        Type: GITHUB
        Location: &quot;https://github.com/projectX/repoY&quot;
        ReportBuildStatus: true
      Triggers:
        BuildType: BUILD
        Webhook: true
        FilterGroups:
          - - Type: EVENT
              Pattern: PULL_REQUEST_CREATED,PULL_REQUEST_UPDATED
      Visibility: PUBLIC_READ
      ResourceAccessRole: !Ref PublicReadRole

  BuildProjectRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      
  BuildProjectPolicy:
    Type: AWS::IAM::Policy
    DependsOn: BuildProjectRole
    Properties:
      PolicyName: !Sub ${AWS::StackName}-CodeBuildPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - codebuild:CreateReportGroup
              - codebuild:CreateReport
              - codebuild:UpdateReport
              - codebuild:BatchPutTestCases
              - codebuild:BatchPutCodeCoverages
            # Create and update test report

            Resource: &quot;*&quot;
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:GetObjectVersion
            # Get and store React build folder on S3

            Resource: &quot;*&quot;
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            # Store the CI process logs inside a logs group
            Resource: arn:aws:logs:*:*:*
          - Effect: Allow
            Action:
              - secretsmanager:*
            # Get secret creedentials ex: CYPRESS_KEY
            
            Resource: &quot;*&quot;
      Roles:
        - !Ref BuildProjectRole

  BuildLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: frontend_build_on_pull
      RetentionInDays: 7
  
  ArtifactBucket:
    Type: 'AWS::S3::Bucket'
    DeletionPolicy: Delete
    Properties:
      BucketName: &quot;some-random-unique-bucket-name&quot;
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  
  PublicReadRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: ['sts:AssumeRole']
            Effect: Allow
            Principal:
              Service: [codebuild.amazonaws.com]
        Version: '2012-10-17'
      Path: /

  PublicReadPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: PublicBuildPolicy
      PolicyDocument:
        Version: &quot;2012-10-17&quot;
        Statement:
          - Effect: Allow
            Action:
              - &quot;logs:GetLogEvents&quot;
            Resource:
              - !Sub &quot;arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${BuildLogGroup}:*&quot;
          - Effect: Allow
            Action:
              - &quot;s3:GetObject&quot;
              - &quot;s3:GetObjectVersion&quot;
            Resource:
              - Fn::Sub:
                - &quot;${ArtifcatArn}/*&quot;
                - {ArtifcatArn: !GetAtt ArtifactBucket.Arn}
      Roles:
        - !Ref PublicReadRole
</code></pre>
<p>To test our code, move into the pull-request.yml file path and run</p>
<pre><code>aws cloudformation create-stack --stack-name pull-request-preview-stack --template-body file://pull-request.yml --capabilities CAPABILITY_NAMED_IAM
</code></pre>
<p>Now visit <a href="https://console.aws.amazon.com/cloudformation/home">Cloudformation Console</a> and you should see a stack with the name pull-request-preview-stack and its status CREATE_IN_PROGRESS or CREATE_COMPLETE</p>
<h2 id="serving-content-with-cloudfront"><strong>Serving Content With CloudFront</strong></h2>
<p>CloudFront is a content delivery network(CDN), CDN can speed up the serving of your static content by caching in the edges that are near you, it is less expensive and it allows you to add a TLS certificate(HTTP) and domain to your static content.</p>
<p>On the other side, we don’t need all of these things but what we want from CloudFront is Lambda@Edge which will allow us to redirect requests by the header to right S3 bucket folder. To explain more, let’s suppose we made 2 pull-request by numbers 121,122, after 2 of them are tested and built successfully, they will get stored in a folder named pr on the Artifact Bucket with the following structure:</p>
<p>pr/</p>
<p>121/</p>
<ul>
<li>assets</li>
<li>index.html</li>
<li>…</li>
<li>…</li>
</ul>
<p>122/</p>
<ul>
<li>assets</li>
<li>index.html</li>
<li>…</li>
<li>…</li>
</ul>
<p>Now when Lambda@Edge comes to play, every request that comes to the CloudFront host(which is a random subdomain under CloudFront xxxxx.cloudfront.net) with a pull-request header and value 122 will be redirected to the folder “122” to serve “122” pull request contents.</p>
<p>In this section, you will learn how to serve S3 content from a CDN and customize users requests by different criteria like (header,query-params…etc) and also build a trigger whenever a build runs successfully, it clears the cache of a specific pull request on the CDN for the new contents.</p>
<h3 id="creating-cloudfront"><strong>Creating CloudFront</strong></h3>
<p>Let’s edit pull-request.yml</p>
<pre><code>nano pull-request.yml
</code></pre>
<p>and add a CloudFront Distribution Service that will primarily serve index.html from ArtifactBucket</p>
<pre><code>Distribution:
  Type: AWS::CloudFront::Distribution
  Properties:
    DistributionConfig:
      Origins:
        - DomainName: !Sub ${ArtifactBucket}.s3.${AWS::Region}.amazonaws.com
          Id: S3Origin
          S3OriginConfig:
            OriginAccessIdentity: !Sub origin-access-identity/cloudfront/${OriginAccessIdentity}
      Enabled: true
      DefaultRootObject: index.html
      Logging:
        Bucket: !Sub ${DistributionBucket}.s3.${AWS::Region}.amazonaws.com
      DefaultCacheBehavior:
        TargetOriginId: S3Origin
        CachePolicyId: !Ref DistributionCachingPolicy
        ViewerProtocolPolicy: https-only
      PriceClass: PriceClass_100
</code></pre>
<p>Cloudfront has 4 major properties that we will explain briefly</p>
<p><!-- raw HTML omitted -->Origins<!-- raw HTML omitted -->: This property refers to where CloudFront retrieves the content, we will be adding only Artifact Bucket, also there is a sub-property <!-- raw HTML omitted -->OriginAccessIdentity<!-- raw HTML omitted --> that restricts access to ArtifactBucket bucket only from CloudFront.</p>
<p><!-- raw HTML omitted -->DefaultRootObject<!-- raw HTML omitted -->: The default file that CloudFront will render from the bucket</p>
<p><!-- raw HTML omitted -->PriceClass<!-- raw HTML omitted -->: To how many regions should our content get cached? we choose PriceClass_100 that’s the minimum value because we don’t care about that.</p>
<p><!-- raw HTML omitted -->Logging<!-- raw HTML omitted -->: We should collect access logs, So we store them in a bucket “DistributionBucket”</p>
<p><!-- raw HTML omitted -->DefaultCacheBehavior<!-- raw HTML omitted --> is a required property so we will add it, but we don’t need any caching behavior from CloudFront to test the pull requests. DefaultCacheBehavior contains 3 required attributes:</p>
<ul>
<li>
<p><strong>TargetOriginId</strong> points to one of our Origins which is S3Origin the only origin we have.</p>
</li>
<li>
<p><strong>ViewerProtocolPolicy</strong> controls whether the user is redirected to HTTPS or uses HTTP or both, we chose https-only.</p>
</li>
<li>
<p><strong>CachePolicyId</strong> , is an important property because we need to allow CloudFront to pass certain headers to Lambda@Edge and the available <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-managed-cache-policies.html#managed-cache-policies-list">managed cache policies</a> don’t allow that, so creating a custom cache policy will help. here is the code for the custom cache policy that allows passing the pull-request header to Lambda@Edge.</p>
<p>DistributionCachingPolicy:
Type: AWS::CloudFront::CachePolicy
Properties:
CachePolicyConfig:
Comment: &ldquo;Allow pass of header and query params to cloudfront&rdquo;
DefaultTTL: 86400
MaxTTL: 31536000
MinTTL: 80400
Name: CacheForHeaderAndQuery
ParametersInCacheKeyAndForwardedToOrigin:
CookiesConfig:
CookieBehavior: none
EnableAcceptEncodingGzip: false
HeadersConfig:
HeaderBehavior: whitelist
Headers:
- pull-request
QueryStringsConfig:
QueryStringBehavior: all</p>
</li>
</ul>
<p>Now the problem we’re facing is that our pull requests content is stored under the PR folder so we cannot serve them as Cloudfront doesn’t allow dynamic selection of contents. So the solution is rerouting the user request before it reaches the S3 bucket and choosing the right path depending on the custom header(pull-request) he passes on the request.</p>
<h3 id="choose-the-right-path-with-lambdaedge"><strong>Choose The Right Path with Lambda@Edge</strong></h3>
<p>To add Lambda@Edge to CloudFront we will modify DefaultCacheBehavior to look like this:</p>
<pre><code>DefaultCacheBehavior:
  TargetOriginId: S3Origin
  ViewerProtocolPolicy: redirect-to-https
  CachePolicyId: !Ref DistributionCachingPolicy
  LambdaFunctionAssociations:
    - EventType: 'origin-request'
      LambdaFunctionARN: !Ref VersionedLambdaFunction
</code></pre>
<p>Let’s create the lambda function, the programming language will be <strong>python</strong> :</p>
<pre><code>LambdaFunction:
  Type: 'AWS::Lambda::Function'
  Properties:
    FunctionName: &quot;cloudfront_lambda&quot;
    Code:
      ZipFile: !Sub |
        import re
        import boto3 

        def handler(event, context):
            client = boto3.client(&quot;s3&quot;)
            bucket = &quot;front-end-preview-bucket&quot;
            response = client.list_objects_v2(Bucket=bucket,Prefix=&quot;pr/&quot;,Delimiter=&quot;/&quot;)
            prs = [p['Prefix'].split('/')[1] for p in response['CommonPrefixes']]

            request = event['Records'][0]['cf']['request']
            print(request)

            headers = request['headers']
            pr = headers.get('pull-request',None)
            
            
            if pr is None:
              print(f&quot;{pr} not found&quot;)
              response = {
                'status': '404',
                'statusDescription': 'No Found',
              }
              return response
            
            pr = pr[0]['value']

            if not pr.isdigit() or not (pr in prs):
              print(f&quot;{pr} not good&quot;)
              response = {
                'status': '404',
                'statusDescription': 'No Found',
              }
              return response

            pr = int(pr)
            request['uri'] = f&quot;/pr/{pr}{request['uri']}&quot;

            print(request)
            return request

    Handler: 'index.handler'
    MemorySize: 128
    Role: !GetAtt 'LambdaRole.Arn'
    Runtime: 'python3.9'
    Timeout: 5

  LambdaRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - 'lambda.amazonaws.com'
            - 'edgelambda.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: FetchContentFromBucket
          PolicyDocument:
            Version: &quot;2012-10-17&quot;
            Statement:
              - Effect: Allow
                Action:
                  - &quot;s3:GetObject&quot;
                  - &quot;s3:ListBucket&quot;
                  - &quot;s3:GetObjectVersion&quot;
                Resource:
                  - Fn::Sub:
                    - &quot;${ArtifcatArn}/*&quot;
                    - {ArtifcatArn: !GetAtt ArtifactBucket.Arn}
                 
      ManagedPolicyArns:
      - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      - &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole&quot;
</code></pre>
<p>To summarize what function do, we fetch all current pull requests that are stored on the bucket and whenever a user makes a request, we check the header(pull-request) value and see if it’s available, if yes we rewrite the request URI to <strong>“/pr/{pr}{request[‘uri’]}”</strong>, if no we return 404 response.</p>
<p>Also, we assign Lambda different policies, some are managed policies like :</p>
<ul>
<li>AWSLambdaBasicExecutionRole</li>
<li>AWSLambdaVPCAccessExecutionRole</li>
</ul>
<p>and others are custom like FetchContentFromBucket to query React build folder from ArtifactBucket.</p>
<h3 id="a-little-demo"><strong>A Little Demo</strong></h3>
<p>After understanding what each service does, we update our pull-request.yml file with the above code. then we update cloud formation with the following command:</p>
<pre><code>aws cloudformation update-stack --stack-name pull-request-preview-stack --template-body file://pull-request.yml --capabilities CAPABILITY_NAMED_IAM
</code></pre>
<p>Now visit <a href="https://console.aws.amazon.com/cloudformation/home">Cloudformation Console</a> and you should see a stack with the name pull-request-preview-stack and its status <strong>UPDATE_IN_PROGRESS</strong> or <strong>UPDATE_COMPLETE</strong>.</p>
<p>To get the CloudFront endpoint Click on pull-request-preview-stack on Cloudformation Console and Click Outputs</p>
<!-- raw HTML omitted -->
<p>What’s missing now, is creating a pull request in our repository. first, we need a new branch</p>
<pre><code>git switch -c feature/test_preview
</code></pre>
<p>then let’s make some changes and finally add, commit, push</p>
<pre><code>git add .
git commit -m &quot;it's getting darker :black:&quot;
git push --set-upstream origin feature/test_preview
</code></pre>
<p>Now let’s wait until the tests pass successfully 👀</p>
<!-- raw HTML omitted -->
<p>If you visit the CloudFront Endpoint you will get a 404 page, this happens because you didn’t pass a pull-request number as a header. So to achieve this we need to install a chrome extension “<a href="https://modheader.com/">mobheader</a>”</p>
<!-- raw HTML omitted -->
<p>you replace 271 with your pull request number that you find on the Github pull request page</p>
<p>Refresh now, Taddaaaa 🎊</p>
<!-- raw HTML omitted -->
<p>Now, Let&rsquo;s suppose that you made a pull request and requested one of your teammates to make a review for you and he reclaimed something buggy is happening, so you went to investigate the issue and solved it and now you’re pushing the updates. After your CI builds and tests successfully, you visit the CloudFront URL and you find the bug still exists, why ?!.</p>
<p>Well it’s because CloudFront caches the build folder on its servers and you need to invalidate the cache from the servers then CloudFront will request the files again from S3</p>
<p>So the approach will be creating a Lambda Function that gets triggered whenever the builds run successfully, The function takes CloudFront DistributionId as an environment variable and make an invalidation request to /pr/{pr_number} subfolder</p>
<pre><code>EventCloudFrontLambda:
  Type: 'AWS::Events::Rule'
  Properties:
    Description: Invalidate Cloudfront after a successful build
    State: ENABLED
    EventPattern:
      source:
        - aws.codebuild
      detail-type:
        - CodeBuild Build State Change
      detail:
        build-status:
          - SUCCEEDED
        project-name:
          - !Ref CodeBuildProject
    Targets:
      -
        Arn: !GetAtt InvalidateCloudFront.Arn
        Id: &quot;TargetFunctionV1&quot;

  InvalidateCloudFront:
    Type: 'AWS::Lambda::Function'
    Properties:
      FunctionName: &quot;invalidate_cloudfront_from_codebuild_lambda&quot;
      Environment:
        Variables:
          DistributionId: !GetAtt Distribution.Id
      Code:
        ZipFile: !Sub |
          import boto3
          import uuid
          import os

          def handler(event, context):
              print(event)
              artifict = event['detail']['additional-information']['artifact']['location']
              pr = artifict.split(&quot;/&quot;)[2]

              distribution_id = os.getenv(&quot;DistributionId&quot;)

              print(distribution_id)

              client = boto3.client(&quot;cloudfront&quot;)
              response = client.create_invalidation(
                  DistributionId=distribution_id,
                  InvalidationBatch={
                      'Paths': {
                          'Quantity': 1,
                          'Items': [
                              f'/pr/{pr}/*',
                          ]
                      },
                      'CallerReference': str(uuid.uuid4())
                  }
              )

              return {&quot;status&quot;:200}
      Handler: 'index.handler'
      MemorySize: 128
      Role: !GetAtt 'LambdaRole.Arn'
      Runtime: 'python3.9'
      Timeout: 15

  InvalidateCloudFrontLogs:
    Type: AWS::Logs::LogGroup
    DependsOn: InvalidateCloudFront
    Properties:
      LogGroupName: !Sub &quot;/aws/lambda/${InvalidateCloudFront}&quot;
      RetentionInDays: 7

  PermissionForEventsToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref InvalidateCloudFront
      Action: &quot;lambda:InvokeFunction&quot;
      Principal: &quot;events.amazonaws.com&quot;
      SourceArn: !GetAtt EventCloudFrontLambda.Arn
</code></pre>
<h3 id="test-updating-the-pull-request-nbspcode"><strong>Test Updating The Pull-request  Code</strong></h3>
<p>Let’s make some changes, if you cloned my repository you can change the index.json file</p>
<p>and replace  “Hello World War 3!  with “Hello World Peace”</p>
<p>and let’s wait for the builds to run successfully and recheck again our preview</p>
<h2 id="challenge-for-you"><strong>Challenge For You</strong></h2>
<p>As our pull request creates a directory on S3, it is a waste of storage and money if we leave the directory on S3 after merging the pull request.</p>
<p>So the challenge will be creating a GitHub action workflow that will delete the folder from S3 after merging the pull request. one of the requirements is using AWS OpenID Connect.</p>
<p>Don’t hesitate to email me, It will be a pleasure for me to review your work 😊</p>
<h2 id="summary"><strong>Summary</strong></h2>
<p>In this article, we walked into different AWS Services(CodeBuild, Cloudfront,S3), we understand the mechanism of AWS IAM finally we learned how to create and deploy our services with Cloudformation</p>
<p>Thanks for your time, stay tuned for new articles.</p>
]]></content:encoded>
    </item>
  </channel>
</rss>
